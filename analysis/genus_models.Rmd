---
title: "Correlates and Models on Genus"
author: "Michael Leukam"
date: '2020-09-07'
output:
  workflowr::wflow_html: default
editor_options:
  chunk_output_type: console
---

## Setup

Clear the workspace and set seed
```{r}
rm(list=ls())
set.seed(818)
```

Load packages
```{r}
# data import, cleaning, export
library(tidyverse)
library(writexl)

# correlations and modeling
library(broom)
library(caret)
library(glmnet)
library(qvalue)

# PCA
library(factoextra)
library(FactoMineR)

# plotting packages
library(survival)
library(survminer)
```

Read in data
Results of derive_vars.Rmd
```{r}
genus_analysis_list <- readRDS("data/genus_analysis_list.rds")

# test variables
imm_cor <- genus_analysis_list$imm_cor$ACC %>% print()
clindat <- genus_analysis_list$clindat$ACC %>% print()
genus_counts <- genus_analysis_list$genus_cpm_list$ACC %>% print()
dervars <- genus_analysis_list$genus_alpha$ACC %>% print()
```

## Diversity correlations

#### Derived variables versus immune correlates
Setup
```{r}
# define starting variables
alpha_list <- genus_analysis_list$genus_alpha %>%
  .[-which(names(.) == "LUAD")] %>%  # missing high level data from LUAD
  .[-which(names(.) == "BLCA")] %>% # duplicate row names (multiple biopsies?)
  .[-which(names(.) == "PRAD")] # duplicate row names (multiple biopsies?)
str(alpha_list, max.level = 2)

imm_cor_list <- genus_analysis_list$imm_cor %>%
  .[names(alpha_list)]
str(imm_cor_list, max.level = 2)

king_list <- genus_analysis_list$high_level_vars %>%
  .[names(alpha_list)]
str(king_list, max.level = 2)

alpha_element <- genus_analysis_list$genus_alpha$STAD %>% print()
imm_cor_element <- genus_analysis_list$imm_cor$STAD %>% print()
king_element <- genus_analysis_list$high_level_vars$STAD %>% print()

# combine kingdom variables and derived vars
dervars_high_level <- function(alpha_element, king_element){
  alpha_element %>% 
    dplyr::left_join(king_element, by = "tcga_barcode")
  }
dervars_list <- map2(alpha_list, king_list, dervars_high_level)
str(dervars_list, max.level = 3)

# test variables
dervars_element <- dervars_list$STAD %>% print()
imm_cor_element <- imm_cor_list$STAD %>% print()

# define function
# returns a list of sublists. Each sublist contains immune correlates
# and alpha diversity derived variables for a single tumor type
imm_cor_df_maker <- function(dervars_element, imm_cor_element){
  print(paste0("analyzing project ", imm_cor_element[1, 2]))
  imm_df <- dervars_element %>% 
    dplyr::left_join(imm_cor_element, by = "tcga_barcode") %>%
    dplyr::filter(!is.na(shannon)) %>%
    # select out dervars
    dplyr::select(-shannon, 
                -simpson, 
                -pielou_evenness, 
                -pielou_evenness, 
                -rar_rich,
                -viral,
                -archaea,
                -bacteria,
                -eukaryota,
                -microbe_cpm,
                -frac_viral,
                -frac_archaea,
                -frac_bacteria,
                -frac_eukaryota,
                # select out text-based factors
                -`TCGA Study`,
                -`Immune Subtype`,
                -`TCGA Subtype`) %>%
    select(!any_of(c("NA", "frac_NA"))) %>%
    as.data.frame() %>%
    column_to_rownames(var = "tcga_barcode")
  dervar_df <- dervars_element %>% 
    # select desired variables
    dplyr::select(tcga_barcode,
                shannon, 
                simpson, 
                pielou_evenness, 
                pielou_evenness, 
                rar_rich,
                viral,
                archaea,
                bacteria,
                eukaryota,
                microbe_cpm,
                frac_viral,
                frac_archaea,
                frac_bacteria,
                frac_eukaryota) %>%
    as.data.frame() %>%
    column_to_rownames(var = "tcga_barcode")
  list("imm_cor" = imm_df, "dervars" = dervar_df)
}

# apply functon
imm_cor_list <- map2(dervars_list, imm_cor_list, imm_cor_df_maker)

# check results
str(imm_cor_list, max.level = 2)
imm_cor_list[[1]][[1]][1:5, 1:5]
imm_cor_list[[1]][[2]][1:5, 1:5]

dervars_dfs <- map(imm_cor_list, ~ .[["dervars"]])
imm_cor_dfs <- map(imm_cor_list, ~ .[["imm_cor"]])

# how many NAs in each column?
map(imm_cor_dfs, function(imm_col){
  map(as.data.frame(imm_col), ~ summary(as.factor(is.na(.))))
}) %>%
  as_tibble() %>%
  print()
```

```{r}
# create combined dataframe
combined_tbl <- map(imm_cor_list, function(list_element){
  imm_cor_tbl <- list_element[["imm_cor"]] %>%
    rownames_to_column(var = "tcga_barcode") %>%
    as_tibble() 
  dervars_tbl <- list_element[["dervars"]] %>%
    rownames_to_column(var = "tcga_barcode") %>%
    as_tibble()
  left_join(imm_cor_tbl, dervars_tbl)
  })

# create columns of comparisons for correlations
var_pairs <- map(colnames(imm_cor_list[[1]][["imm_cor"]]), function(imm_cor_var){
  enframe(colnames(imm_cor_list[[1]][["dervars"]])) %>%
    bind_cols(rep(imm_cor_var, times = nrow(.))) %>%
    select(dervar = value, imm_cor = `...3`)
  }) %>%
  bind_rows() %>%
  setNames(c("x", "y")) %>%
  print()
  
# get correlations
combined_spearman <- map(combined_tbl, function(df){
  cor_tab <- var_pairs %>% 
    mutate(
      r_test = purrr::map2(
        x, y, 
        possibly(~ stats::cor.test(df[[.x]], df[[.y]], method = "spearman"),
          otherwise = data.frame())),
      r_test = purrr::map(r_test, tidy)
      ) %>%
    unnest(r_test) %>%
    dplyr::rename(summary_var = x, imm_cor = y) %>%
    mutate(p_adj_fdr = case_when(
      is.na(.$p.value) == FALSE ~ p.adjust(.$p.value)))
    })  

combined_pearson <- map(combined_tbl, function(df){
  cor_tab <- var_pairs %>% 
    mutate(
      r_test = purrr::map2(
        x, y, 
        possibly(~ stats::cor.test(df[[.x]], df[[.y]], method = "pearson"),
          otherwise = data.frame())),
      r_test = purrr::map(r_test, tidy)
      ) %>%
    unnest(r_test) %>%
    dplyr::rename(summary_var = x, imm_cor = y) %>%
    mutate(p_adj_fdr = case_when(
      is.na(.$p.value) == FALSE ~ p.adjust(.$p.value)))
    })  

# clear out empty correlation tables
combined_spearman$UVM <- NULL
combined_spearman$PAAD <- NULL
combined_pearson$UVM <- NULL
combined_pearson$PAAD <- NULL

cleaned_spearman <- map(combined_spearman, function(df){
  df %>% 
    dplyr::select(summary_var, 
                  imm_cor, 
                  estimate, 
                  p_adj_fdr, 
                  p.value, 
                  statistic, 
                  method, 
                  alternative) %>%
    arrange(p_adj_fdr)
}) 
write_xlsx(cleaned_correlations, "output/tcga_correlations_spearman.xlsx")

cleaned_pearson <- map(combined_pearson, function(df){
  df %>% dplyr::select(summary_var, imm_cor, estimate, p_adj_fdr, p.value, statistic, method, alternative)
}) 
write_xlsx(cleaned_correlations, "output/tcga_correlations_pearson.xlsx")
  
```

#### Plots of summary variables
```{r}
# get combined/single tibble
dervars_unified_tbl <- map(dervars_dfs, function(df){
  df %>%
    rownames_to_column(var = "tcga_barcode") %>%
    as_tibble()
}) %>% 
  enframe() %>%
  unnest(value) %>%
  dplyr::rename(tcga_proj = name) %>%
  print()

# make list of input variables from column names
# exclude tcga project and barcode
inputvars <- as.list(colnames(dervars_unified_tbl[3:ncol(dervars_unified_tbl)]))
names(inputvars) <- colnames(dervars_unified_tbl[3:ncol(dervars_unified_tbl)])
inputvars

# function for plot
### NOT WORKING YET
map(inputvars, function(inputvar){
  dervars_unified_tbl %>% 
    ggplot(aes(x = reorder(tcga_proj, inputvar, mean), 
             y = inputvar, 
             fill = tcga_proj, 
             color = tcga_proj)) +
    geom_violin(scale = "width") +
    geom_boxplot(width = 0.15, fill = "white") +
    theme_classic2() +
    theme(legend.position = "none") +
    theme(axis.text.x = element_text(angle = 60, hjust=1)) +
    xlab("") +
    ggtitle(paste0("Genus ", inputvar, " by tumor type"))
})
  
dervars_unified_tbl %>% 
  ggplot(aes(x = reorder(tcga_proj, simpson, mean), y = simpson, fill = tcga_proj, color = tcga_proj)) +
  geom_violin(scale = "width") +
  geom_boxplot(width = 0.15, fill = "white") +
  theme_classic2() +
  theme(legend.position = "none") +
  theme(axis.text.x = element_text(angle = 60, hjust=1)) +
  xlab("") +
  ggtitle("Genus Simpson diversity by tumor type")

dervars_unified_tbl %>% 
  ggplot(aes(x = reorder(tcga_proj, invsimpson, mean), 
             y = invsimpson, 
             fill = tcga_proj, 
             color = tcga_proj)) +
  geom_violin(scale = "width") +
  geom_boxplot(width = 0.15, fill = "white") +
  theme_classic2() +
  theme(legend.position = "none") +
  theme(axis.text.x = element_text(angle = 60, hjust=1)) +
  xlab("") +
  ggtitle("Genus inverse Simpson diversity by tumor type")

dervars_unified_tbl %>% 
  ggplot(aes(x = reorder(tcga_proj, pielou_evenness, mean), 
             y = pielou_evenness, 
             fill = tcga_proj, 
             color = tcga_proj)) +
  geom_violin(scale = "width") +
  geom_boxplot(width = 0.15, fill = "white") +
  theme_classic2() +
  theme(legend.position = "none") +
  theme(axis.text.x = element_text(angle = 60, hjust=1)) +
  xlab("") +
  ggtitle("Genus Pielou evenness by tumor type")

dervars_unified_tbl %>% 
  ggplot(aes(x = reorder(tcga_proj, rar_rich, mean), 
             y = rar_rich, 
             fill = tcga_proj, 
             color = tcga_proj)) +
  geom_violin(scale = "width") +
  geom_boxplot(width = 0.15, fill = "white") +
  theme_classic2() +
  theme(legend.position = "none") +
  theme(axis.text.x = element_text(angle = 60, hjust=1)) +
  xlab("") +
  ggtitle("Genus rarified richness by tumor type")

dervars_unified_tbl %>% 
  ggplot(aes(x = reorder(tcga_proj, rar_rich, mean), 
             y = rar_rich, 
             fill = tcga_proj, 
             color = tcga_proj)) +
  geom_violin(scale = "width") +
  geom_boxplot(width = 0.15, fill = "white") +
  theme_classic2() +
  theme(legend.position = "none") +
  theme(axis.text.x = element_text(angle = 60, hjust=1)) +
  xlab("") +
  ggtitle("Genus rarified richness by tumor type")

dervars_unified_tbl %>% 
  ggplot(aes(x = reorder(tcga_proj, viral, mean), 
             y = viral, 
             fill = tcga_proj, 
             color = tcga_proj)) +
  geom_violin(scale = "width") +
  geom_boxplot(width = 0.15, fill = "white") +
  theme_classic2() +
  theme(legend.position = "none") +
  theme(axis.text.x = element_text(angle = 60, hjust=1)) +
  xlab("") +
  ggtitle("Viral cpm by tumor")

dervars_unified_tbl %>% 
  ggplot(aes(x = reorder(tcga_proj, archaea, mean), 
             y = archaea, 
             fill = tcga_proj, 
             color = tcga_proj)) +
  geom_violin(scale = "width") +
  geom_boxplot(width = 0.15, fill = "white") +
  theme_classic2() +
  theme(legend.position = "none") +
  theme(axis.text.x = element_text(angle = 60, hjust=1)) +
  xlab("") +
  ggtitle("Archaea CPM by tumor")

dervars_unified_tbl %>% 
  ggplot(aes(x = reorder(tcga_proj, bacteria, mean), 
             y = bacteria, 
             fill = tcga_proj, 
             color = tcga_proj)) +
  geom_violin(scale = "width") +
  geom_boxplot(width = 0.15, fill = "white") +
  theme_classic2() +
  theme(legend.position = "none") +
  theme(axis.text.x = element_text(angle = 60, hjust=1)) +
  xlab("") +
  ggtitle("Bacteria CPM by tumor")

dervars_unified_tbl %>% 
  ggplot(aes(x = reorder(tcga_proj, bacteria, mean), 
             y = log(bacteria), 
             fill = tcga_proj, 
             color = tcga_proj)) +
  geom_violin(scale = "width") +
  geom_boxplot(width = 0.15, fill = "white") +
  theme_classic2() +
  theme(legend.position = "none") +
  theme(axis.text.x = element_text(angle = 60, hjust=1)) +
  xlab("") +
  ggtitle("Bacteria log(CPM) by tumor")

dervars_unified_tbl %>% 
  ggplot(aes(x = reorder(tcga_proj, eukaryota, mean), 
             y = eukaryota, 
             fill = tcga_proj, 
             color = tcga_proj)) +
  geom_violin(scale = "width") +
  geom_boxplot(width = 0.15, fill = "white") +
  theme_classic2() +
  theme(legend.position = "none") +
  theme(axis.text.x = element_text(angle = 60, hjust=1)) +
  xlab("") +
  ggtitle("Eukaryota CPM by tumor")

dervars_unified_tbl %>% 
  ggplot(aes(x = reorder(tcga_proj, microbe_cpm, mean), 
             y = microbe_cpm, 
             fill = tcga_proj, 
             color = tcga_proj)) +
  geom_violin(scale = "width") +
  geom_boxplot(width = 0.15, fill = "white") +
  theme_classic2() +
  theme(legend.position = "none") +
  theme(axis.text.x = element_text(angle = 60, hjust=1)) +
  xlab("") +
  ggtitle("Any microbial CPM by tumor")

dervars_unified_tbl %>% 
  ggplot(aes(x = reorder(tcga_proj, microbe_cpm, mean), 
             y = log(microbe_cpm), 
             fill = tcga_proj, 
             color = tcga_proj)) +
  geom_violin(scale = "width") +
  geom_boxplot(width = 0.15, fill = "white") +
  theme_classic2() +
  theme(legend.position = "none") +
  theme(axis.text.x = element_text(angle = 60, hjust=1)) +
  xlab("") +
  ggtitle("Any microbial log(CPM) by tumor")

dervars_unified_tbl %>% 
  ggplot(aes(x = reorder(tcga_proj, frac_viral, mean), 
             y = frac_viral, 
             fill = tcga_proj, 
             color = tcga_proj)) +
  geom_violin(scale = "width") +
  geom_boxplot(width = 0.15, fill = "white") +
  theme_classic2() +
  theme(legend.position = "none") +
  theme(axis.text.x = element_text(angle = 60, hjust=1)) +
  xlab("") +
  ggtitle("Fraction of viral CPM by tumor")

dervars_unified_tbl %>% 
  ggplot(aes(x = reorder(tcga_proj, frac_archaea, mean), 
             y = frac_archaea, 
             fill = tcga_proj, 
             color = tcga_proj)) +
  geom_violin(scale = "width") +
  geom_boxplot(width = 0.15, fill = "white") +
  theme_classic2() +
  theme(legend.position = "none") +
  theme(axis.text.x = element_text(angle = 60, hjust=1)) +
  xlab("") +
  ggtitle("Fraction of archaea CPM by tumor")

dervars_unified_tbl %>% 
  ggplot(aes(x = reorder(tcga_proj, frac_bacteria, mean), 
             y = frac_bacteria, 
             fill = tcga_proj, 
             color = tcga_proj)) +
  geom_violin(scale = "width") +
  geom_boxplot(width = 0.15, fill = "white") +
  theme_classic2() +
  theme(legend.position = "none") +
  theme(axis.text.x = element_text(angle = 60, hjust=1)) +
  xlab("") +
  ggtitle("Fraction of bacteria CPM by tumor")

dervars_unified_tbl %>% 
  ggplot(aes(x = reorder(tcga_proj, frac_eukaryota, mean), 
             y = frac_eukaryota, 
             fill = tcga_proj, 
             color = tcga_proj)) +
  geom_violin(scale = "width") +
  geom_boxplot(width = 0.15, fill = "white") +
  theme_classic2() +
  theme(legend.position = "none") +
  theme(axis.text.x = element_text(angle = 60, hjust=1)) +
  xlab("") +
  ggtitle("Fraction of eukaryote CPM by tumor")
```





#### Correlates of summary variables
```{r}
map(cleaned_pearson, function(df){
  df %>%
    dplyr::filter(p_adj_fdr < 0.1)
})

cleaned_pearson$SKCM %>% arrange(p_adj_fdr) %>% slice(1:3) %>% print()

combined_tbl %>% 
  .[["SKCM"]] %>%
  dplyr::select(frac_viral, plasma_cells = `Plasma Cells`) %>%
  ggplot(aes(x = frac_viral, y = plasma_cells)) +
    geom_point() +
    geom_smooth() +
    ggtitle("Melanoma plasma cells vs viral fraction")
```

#### Genera that differed most between melanoma responders and nonresponders
```{r}
sel_gen <- c("Bacillus", "Aerococcus", "Enterocloster", "Corynebacterium", "Prevotella", "Helicobacter")


```

#### Scatterplots for immune correlates  
```{r}
# get immune correlate with sample name
# input is list by tcga project
# output is single flat table with tcga_project as a column
tcr_richness <- map(imcor_vars_list, function(imm_cor){
  imm_cor["TCR Richness"] %>%
    as.data.frame() %>%
    rownames_to_column(var = "tcga_barcode") %>%
    as_tibble()
}) %>% 
  enframe() %>%
  unnest(value) %>%
  dplyr::rename(tcga_project = name) %>%
  print()

# use trimmed counts that correspond to cases with immune data
# trimmed for correlation analysis above
# input is list by tcga project
# output is single flat table with tcga_project as a column
enterocloster <- map(counts_trim, function(counts){
  counts["Enterocloster"] %>%
    as.data.frame() %>%
    rownames_to_column(var = "tcga_barcode") %>%
    as_tibble()
}) %>% 
  enframe() %>%
  unnest(value) %>%
  dplyr::rename(tcga_project = name) %>%
  print()

tcr_richness_vs_enterocloster <- tcr_richness %>%
  left_join(enterocloster) %>%
  dplyr::filter(!is.na(`TCR Richness`)) %>%
  dplyr::filter(!is.na(Enterocloster)) %>%
  dplyr::rename(tcr_richness = `TCR Richness`) %>%
  ggplot(aes(
      y = tcr_richness,
      x = Enterocloster)
    ) +
    geom_point(alpha = 0.2) +
    geom_smooth() +
    stat_cor(method = "spearman",
             cor.coef.name = "rho",
             label.y = 1000) +
    theme_classic2() +
    theme(legend.position = "none") +
    ylim(c(-1, 1050))
  
tcr_richness_vs_enterocloster

tcr_richness_vs_enterocloster_facet <- tcr_richness %>%
  left_join(enterocloster) %>%
  dplyr::filter(!is.na(`TCR Richness`)) %>%
  dplyr::filter(!is.na(Enterocloster)) %>%
  dplyr::rename(tcr_richness = `TCR Richness`) %>%
  ggplot(aes(
      y = tcr_richness,
      x = Enterocloster,
      color = tcga_project)
    ) +
    geom_point(alpha = 0.2) +
    geom_smooth() +
    stat_cor(method = "spearman",
             cor.coef.name = "rho",
             label.y = 1000) +
    facet_wrap(facets = "tcga_project") +
    theme_classic2() +
    theme(legend.position = "none")
  
tcr_richness_vs_enterocloster_facet

#-----------------------------------------
tgf_beta <- map(imcor_vars_list, function(imm_cor){
  imm_cor["TGF-beta Response"] %>%
    as.data.frame() %>%
    rownames_to_column(var = "tcga_barcode") %>%
    as_tibble()
}) %>% 
  enframe() %>%
  unnest(value) %>%
  dplyr::rename(tcga_project = name) %>%
  print()

# use trimmed counts that correspond to cases with immune data
# trimmed for correlation analysis above
# input is list by tcga project
# output is single flat table with tcga_project as a column
orthopoxvirus <- map(counts_trim, function(counts){
  counts["Orthopoxvirus"] %>%
    as.data.frame() %>%
    rownames_to_column(var = "tcga_barcode") %>%
    as_tibble()
}) %>% 
  enframe() %>%
  unnest(value) %>%
  dplyr::rename(tcga_project = name) %>%
  print()

# plot "pancancer" scatter plot
tgf_beta_vs_orthopoxvirus <- tgf_beta %>%
  left_join(orthopoxvirus) %>%
  dplyr::filter(!is.na(`TGF-beta Response`)) %>%
  dplyr::filter(!is.na(Orthopoxvirus)) %>%
  ggplot(aes(
      y = `TGF-beta Response`,
      x = Orthopoxvirus)
    ) +
    geom_point(alpha = 0.2) +
    geom_smooth() +
    stat_cor(method = "spearman",
             cor.coef.name = "rho",
             label.y = 1.5) +
    theme_classic2() +
    theme(legend.position = "none")
  
tgf_beta_vs_orthopoxvirus

# scatterplot facet by tumor type
tgf_beta_vs_orthopoxvirus <- tgf_beta %>%
  left_join(orthopoxvirus) %>%
  dplyr::filter(!is.na(`TGF-beta Response`)) %>%
  dplyr::filter(!is.na(Orthopoxvirus)) %>%
  ggplot(aes(
      y = `TGF-beta Response`,
      x = Orthopoxvirus,
      color = tcga_project)
    ) +
    geom_point(alpha = 0.2) +
    geom_smooth() +
    stat_cor(method = "spearman",
             cor.coef.name = "rho",
             label.y = 1.5) +
    facet_wrap(facets = "tcga_project") +
    theme_classic2() +
    theme(legend.position = "none")
  
tgf_beta_vs_orthopoxvirus
```

## PCA plots
```{r}
genus_for_pca <- counts_tbl_list %>%
  reduce(bind_rows) %>%
  as.data.frame() %>%
  column_to_rownames(var = "tcga_barcode")

set.seed(818)

genus_pca <- PCA(genus_for_pca, scale.unit = TRUE,  ncp = 10, graph = FALSE)
fviz_pca_var(genus_pca, col.var = "cos2",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"), 
             label = FALSE
             )
# Contributions of variables to PC1
fviz_contrib(genus_pca, choice = "var", axes = 1, top = 10)
# Contributions of variables to PC2
fviz_contrib(genus_pca, choice = "var", axes = 2, top = 10)

# labeled PCA
fviz_pca_ind(genus_pca)
```

Remove outliers
```{r}
genus_pca$ind$coord %>% as.data.frame %>% rownames_to_column(var = "tcga_barcode") %>% as_tibble() %>% arrange(Dim.2)

genus_pca$ind$coord %>% as.data.frame %>% rownames_to_column(var = "tcga_barcode") %>% as_tibble() %>% arrange(desc(Dim.2))

counts_filt <- counts_tbl_list %>%
  reduce(bind_rows) %>%
  dplyr::filter(!tcga_barcode %in% c("TCGA-B0-5702", "TCGA-VQ-A8P5", "TCGA-A7-A13E")) %>%
  as.data.frame() %>%
  column_to_rownames(var = "tcga_barcode") 

dim(counts_filt)
dim(genus_for_pca)

genus_pca_filt <- PCA(counts_filt, scale.unit = TRUE, ncp = 10, graph = FALSE)
fviz_pca_ind(genus_pca_filt)
fviz_pca_var(genus_pca_filt, col.var = "cos2",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"), 
             label = FALSE
             )
```


```    
    
  left_join(genus_tbl) %>%
  dplyr::select(-c(os_status, os_days)) %>%
  # convert to data.frame
  as.data.frame() %>%
  column_to_rownames(var = "tcga_barcode") %>%
  print()

surv_genus[1:5, 1:5]

# partition the data
set.seed(818)
genus_train_samples <- twoyr_os_surv_genus$twoyr_os_status %>%
  createDataPartition(p = 0.8, list = FALSE) 
genus_train <- surv_genus[genus_train_samples, ]
genus_test <- surv_genus[-genus_train_samples, ]

# define predictor variables
x <- model.matrix(twoyr_os_status~., genus_train)[,-1]
# Outcome variable
y <- genus_train$twoyr_os_status

# are the data unbalanced? How well will guessing "alive" for everyone work
# create baseline model - how well will a model that always guesses "normal" do?
table(genus_train$twoyr_os_status)
204/(204 + 96)
# with no additional information, guessing "alive" will be right 68% of the time

# find the best AUC using cross-validation
# alpha = 1 for lasso 
cv_lasso <- cv.glmnet(x, y, 
                      alpha = 1, 
                      family = "binomial", 
                      type.measure = "auc")
plot(cv_lasso)

# lowest lambda minimizes prediction error
cv_lasso$lambda.min
# the purpose of regularization is to balance accuracy and simplicity or a model with the smallest number of predictors that also gives a good accuracy. cv.glmnet() finds the value of lambda that gives the simplest model that lies within one standard error of the optimal value of lambda: lambda.1se
cv_lasso$lambda.1se

# coefficients for lambda min
coef(cv_lasso, cv_lasso$lambda.min)
# coefficients for lambda 1se
coef(cv_lasso, cv_lasso$lambda.1se)

# final model with lambda.min
cv_final_model <- glmnet(x, y, alpha = 1, family = "binomial",
                      lambda = cv_lasso$lambda.min)

# make predictions on the test data
x_test <- model.matrix(twoyr_os_status~., genus_test)[,-1]
predictions <- cv_final_model %>% 
  predict(x_test) %>% 
  as.vector()

# make predictions on test data
x_test <- model.matrix(twoyr_os_status~., genus_test)[,-1]
probabilities <- cv_final_model %>% predict(newx = x_test)
predicted_classes <- ifelse(probabilities > 0.5, 1, 0)
# model accuracy
observed_classes <- genus_test$twoyr_os_status
mean(predicted_classes == observed_classes)
# model performance metrics
predictions <- cv_final_model %>% 
  predict(x_test) %>% 
  as.vector()
data.frame(
  RMSE = RMSE(predictions, genus_test$twoyr_os_status),
  Rsquare = R2(predictions, genus_test$twoyr_os_status)
)
# get AUC
max(cv_lasso$cvm)

# get most influential variables (top 10)
twoyr_varimp <- varImp(cv_final_model, 
                     lambda = cv_lasso$lambda.min, 
                     scale = FALSE) %>%
  rownames_to_column(var = "rowname") %>%
  arrange(desc(Overall)) %>%
  mutate(rowname = fct_reorder(rowname, Overall)) %>%
  slice(1:10)

twoyr_varimp

twoyr_varimp_plot <- ggplot(data = twoyr_varimp, aes(x = rowname, y = Overall)) +
  geom_segment(aes(x = rowname, 
                   xend = rowname, y = 0, 
                   yend = Overall), color="gray") +
  geom_point(color="dark red", size=4) +
  labs(title = "Genus predictors of two-year survival") +
  xlab("") +
  ylab("Importance") +
  theme_classic() +
  coord_flip() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank()
  ) 
twoyr_varimp_plot
```


## Clinical Outcomes

#### Clinical and immune variables modeled on genera

```{r}
# testing variable
clindat <- STAD_clindat

# make list of clinical data
clindat_list <- genus_analysis_list$clindat

# ovarian cancer clinical data uses figo instead of AJCC staging
# infer nodal and metastatic status from figo staging
clindat_ov <- clindat_list[["OV"]] %>%
  mutate(ajcc_pathologic_t = rep(NA, nrow(.))) %>%
  mutate(ajcc_pathologic_n = ifelse(
    figo_stage %in% c("Stage IIIA", "Stage IIIB", "Stage IIIC", "Stage IVA", "Stage IVB"),
    1, 
    ifelse(is.na(figo_stage), NA, 0))) %>% 
  mutate(ajcc_pathologic_m = ifelse(
    figo_stage %in% c("Stage IVA", "Stage IVB"),
    1,
    ifelse(is.na(figo_stage), NA, 0))) %>%
  dplyr::select(figo_stage, ajcc_pathologic_t, ajcc_pathologic_n, ajcc_pathologic_m, everything()) 

# add repaired dataframe back to list
clindat_list[["OV"]] <- clindat_ov
  
# function to make dataframe for clinical data
# all outcomes defined as binary (0/1) outcome
outcomes_cleaner <- function(clindat){
  # examine only primary tumors
  clindat_prime <- clindat %>%
    dplyr::filter(sample_type == "Primary Tumor")
  # define binary survival outcome variables
  surv_cols <- clindat_prime %>% 
    # examine only primary tumors
    dplyr::filter(sample_type == "Primary Tumor") %>%
    dplyr::select(tcga_barcode, days_to_death, days_to_last_follow_up) %>%
    mutate(
      os_status = ifelse(is.na(days_to_death), 0, 1)
      ) %>%
    mutate(
      os_days = ifelse(os_status == 1, days_to_death, days_to_last_follow_up)
      ) %>%
    dplyr::select(tcga_barcode, os_status, os_days) %>%
    mutate(
      twoyr_os_status = ifelse(os_status == 0, 0,
                              ifelse(os_days > 730, 0, 1))
      ) %>%
    mutate(
      fiveyr_os_status = ifelse(os_status == 0, 0,
                               ifelse(os_days > 1826, 0, 1))
      ) %>%
    dplyr::select(tcga_barcode, 
                  twoyr_os_status, 
                  fiveyr_os_status)
  # binary demographics variables
  demo_cols <- clindat_prime %>%
    dplyr::select(tcga_barcode, gender, age_at_index, race) %>%
    mutate(
      female_sex = ifelse(gender == "female", 1,
                          ifelse(is.na(gender), NA, 1))
      ) %>%
    mutate(
      older_adult = ifelse(age_at_index > 65, 1,
                           ifelse(is.na(age_at_index), NA, 1))
      ) %>%
    mutate(
      nonwhite_race = ifelse(race == "white", 0, 
                            ifelse(is.na(race), NA, 1))
      ) %>%
    dplyr::select(tcga_barcode, female_sex, older_adult, nonwhite_race) 
  # binary tumor variables
  tumor_cols <- clindat_prime %>%
    dplyr::select(tcga_barcode, 
                  tumor_stage, 
                  ajcc_pathologic_t,
                  ajcc_pathologic_m,
                  ajcc_pathologic_n) %>%
    mutate(
      stage_iv = ifelse(grepl("iv", tumor_stage), 1,
                          ifelse(tumor_stage == "not reported", NA, 
                                        ifelse(is.na(tumor_stage), NA, 1)))
           ) %>%
    mutate(
      t4 = ifelse(grepl("4", ajcc_pathologic_t), 1,
                          ifelse(ajcc_pathologic_t == "TX", NA,
                                        ifelse(is.na(ajcc_pathologic_t), NA, 1)))
    ) %>%
    mutate(
      metastatic = ifelse(ajcc_pathologic_m == "M1", 1, 
                          ifelse(ajcc_pathologic_m == "MX", NA,
                                        ifelse(is.na(ajcc_pathologic_m), NA, 1)))
    ) %>%
    mutate(
      nodal_involvement = ifelse(ajcc_pathologic_n == "N0", 0,
                                 ifelse(ajcc_pathologic_n == "NX", NA, 
                                        ifelse(is.na(ajcc_pathologic_n), NA, 1)))
    ) %>%
    dplyr::select(tcga_barcode, stage_iv, t4, metastatic, nodal_involvement)
  surv_cols %>%
    left_join(demo_cols) %>%
    left_join(tumor_cols)
}
  
outcomes_data <- map(clindat_list, outcomes_cleaner)
  
```

Interesting nonbinary clinical variables:
* primary_diagnosis
* tissue_or_organ_of_origin
* site_of_resection_or_surgery
