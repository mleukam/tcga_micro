---
title: "Correlates and Models on Genus"
author: "Michael Leukam"
date: '2021-02-02'
output:
  workflowr::wflow_html: default
editor_options:
  chunk_output_type: console
---

## Setup

Clear the workspace and set seed
```{r}
rm(list=ls())
set.seed(818)
```

Load packages
```{r}
# correlations and modeling
library(broom)
library(caret)
library(glmnet)
library(qvalue)

# PCA
library(factoextra)
library(FactoMineR)

# plotting packages
library(survival)
library(survminer)
library(ComplexHeatmap)

# data import, cleaning, export
library(tidyverse)
library(writexl)
```

Read in data
Results of derive_vars.Rmd
```{r}
genus_analysis_list <- readRDS("data/genus_analysis_list.rds")
genus_counts_alldata <- readRDS("output/genus_counts_alldata.rds")
```

## Iterations

Example tumors: HNSC, STAD, SKCM

Model 1:
- Normalization: CPM (total counts), TMM
- Transformation: log2 via voom
- Batch correction:
    * Batch: center + plate
    * Model: tumor type
    * Method: limma removeBatchEffect
- Model:
    * Outcomes: 
        - Lymphocyte Infiltration Signature Score
        - BCR Shannon
        - TCR Shannon
        - Macrophage Regulation
    * Method:
        - Spearman correlation
    
```{r}
# select data type
cpm_total <- genus_counts_alldata[["genus_cpm"]]
cpm_clindat <- genus_counts_alldata[["clindat_cpm"]]

# select tumors, get TCGA barcodes
cpm_selected_barcodes <- cpm_clindat %>%
  as.data.frame() %>%
  rownames_to_column(var = "tcga_barcode") %>%
  as_tibble() %>%
  dplyr::filter(name %in% c("HNSC", "STAD", "SKCM")) %>%
  pull("tcga_barcode")

# filter expression for selected tumors
cpm_filtered <- cpm_total %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column(var = "tcga_barcode") %>%
  as_tibble() %>%
  dplyr::filter(tcga_barcode %in% cpm_selected_barcodes) %>%
  print()

# select immune correlates
imm_cor <- genus_analysis_list$imm_cor %>%
  enframe() %>%
  dplyr::filter(name %in% c("HNSC", "STAD", "SKCM")) %>%
  unnest(value) %>%
  dplyr::select(tcga_barcode, 
    tcga_proj = `TCGA Study`, 
    lymphocyte_score = `Lymphocyte Infiltration Signature Score`, 
    bcr_shannon = `BCR Shannon`, 
    tcr_shannon = `TCR Shannon`, 
    macrophage_regulation = `Macrophage Regulation`) %>%
  print()
```

Model 2:
- Normalization: CPM (microbial counts only), TMM
- Transformation: log2 via voom
- Batch correction:
    * Batch: center + plate
    * Model: tumor type
    * Method: limma removeBatchEffect
- Model:
    * Outcomes: 
        - Lymphocyte Infiltration Signature Score
        - BCR Shannon
        - TCR Shannon
        - Macrophage Regulation
    * Method:
        - Spearman correlation


## Diversity correlations

#### Derived variables versus immune correlates
Setup
```{r}
# define starting variables
alpha_list <- genus_analysis_list$corrected_genus_alpha # %>%
  # .[-which(names(.) == "LUAD")] %>%  # missing high level data from LUAD
  # .[-which(names(.) == "BLCA")] %>% # duplicate row names (multiple biopsies?)
  # .[-which(names(.) == "PRAD")] # duplicate row names (multiple biopsies?)
str(alpha_list, max.level = 2)

imm_cor_list <- genus_analysis_list$imm_cor %>%
  .[names(alpha_list)]
str(imm_cor_list, max.level = 2)

king_list <- genus_analysis_list$corrected_high_level_vars %>%
  .[names(alpha_list)]
str(king_list, max.level = 2)

# test variables
alpha_element <- genus_analysis_list$corrected_genus_alpha$LUAD %>% print()
imm_cor_element <- genus_analysis_list$imm_cor$LUAD %>% print()
king_element <- genus_analysis_list$corrected_high_level_vars$LUAD %>% print()

# combine kingdom variables and derived vars
dervars_high_level <- function(alpha_element, king_element){
  alpha_element %>% 
    dplyr::left_join(king_element, by = "tcga_barcode")
  }
dervars_list <- map2(alpha_list, king_list, dervars_high_level)
str(dervars_list, max.level = 3)

# test variables
dervars_element <- dervars_list$LUAD %>% print()
imm_cor_element <- imm_cor_list$LUAD %>% print()

# whole TCGA correlations
dervars_combined <- dervars_list %>% bind_rows() %>% print()
imm_cor_combined <- imm_cor_list %>% bind_rows() %>% print()

# make global TCGA dataframe
imm_cor_combined_df <- dervars_combined %>%
  left_join(imm_cor_combined) %>%
  dplyr::select(-shannon, 
                -simpson, 
                -invsimpson,
                -pielou_evenness, 
                -rar_rich,
                -viruses,
                -archaea,
                -bacteria,
                -eukaryota,
                -microbial_cpm,
                -frac_viruses,
                -frac_archaea,
                -frac_bacteria,
                -frac_eukaryota,
                # select out text-based factors
                -`TCGA Study`,
                -`Immune Subtype`,
                -`TCGA Subtype`) %>%
  print()

# define function
# returns a list of sublists. Each sublist contains immune correlates
# and alpha diversity derived variables for a single tumor type
imm_cor_df_maker <- function(dervars_element, imm_cor_element){
  print(paste0("analyzing project ", imm_cor_element[1, 2]))
  imm_df <- dervars_element %>% 
    dplyr::left_join(imm_cor_element, by = "tcga_barcode") %>%
    dplyr::filter(!is.na(shannon)) %>%
    # select out dervars
    dplyr::select(-shannon, 
                -simpson, 
                -invsimpson,
                -pielou_evenness, 
                -rar_rich,
                -viruses,
                -archaea,
                -bacteria,
                -eukaryota,
                -microbial_cpm,
                -frac_viruses,
                -frac_archaea,
                -frac_bacteria,
                -frac_eukaryota,
                # select out text-based factors
                -`TCGA Study`,
                -`Immune Subtype`,
                -`TCGA Subtype`) %>%
    select(!any_of(c("NA", "frac_NA"))) %>%
    as.data.frame() %>%
    column_to_rownames(var = "tcga_barcode")
  dervar_df <- dervars_element %>% 
    # select desired variables
    dplyr::select(tcga_barcode,
                shannon, 
                simpson, 
                invsimpson,
                pielou_evenness, 
                rar_rich,
                viruses,
                archaea,
                bacteria,
                eukaryota,
                microbial_cpm,
                frac_viruses,
                frac_archaea,
                frac_bacteria,
                frac_eukaryota) %>%
    as.data.frame() %>%
    column_to_rownames(var = "tcga_barcode")
  list("imm_cor" = imm_df, "dervars" = dervar_df)
}

# apply functon
imm_cor_list <- map2(dervars_list, imm_cor_list, imm_cor_df_maker)

# check results
str(imm_cor_list, max.level = 2)
imm_cor_list[[1]][[1]][1:5, 1:5]
imm_cor_list[[1]][[2]][1:5, 1:5]

dervars_dfs <- map(imm_cor_list, ~ .[["dervars"]])
imm_cor_dfs <- map(imm_cor_list, ~ .[["imm_cor"]])

# how many NAs in each column?
map(imm_cor_dfs, function(imm_col){
  map(as.data.frame(imm_col), ~ summary(as.factor(is.na(.))))
}) %>%
  as_tibble()
```

```{r}
# create combined dataframe
combined_tbl <- map(imm_cor_list, function(list_element){
  imm_cor_tbl <- list_element[["imm_cor"]] %>%
    rownames_to_column(var = "tcga_barcode") %>%
    as_tibble() 
  dervars_tbl <- list_element[["dervars"]] %>%
    rownames_to_column(var = "tcga_barcode") %>%
    as_tibble()
  left_join(imm_cor_tbl, dervars_tbl)
  })
  
# create columns of comparisons for correlations
var_pairs <- map(colnames(imm_cor_list[[1]][["imm_cor"]]), function(imm_cor_var){
  enframe(colnames(imm_cor_list[[1]][["dervars"]])) %>%
    bind_cols(rep(imm_cor_var, times = nrow(.))) %>%
    select(dervar = value, imm_cor = `...3`)
  }) %>%
  bind_rows() %>%
  setNames(c("x", "y")) %>%
  print()
  
# get correlations
combined_spearman <- map(combined_tbl, function(df){
  cor_tab <- var_pairs %>% 
    mutate(
      r_test = purrr::map2(
        x, y, 
        possibly(~ stats::cor.test(df[[.x]], df[[.y]], method = "spearman"),
          otherwise = data.frame())),
      r_test = purrr::map(r_test, tidy)
      ) %>%
    unnest(r_test) %>%
    dplyr::rename(summary_var = x, imm_cor = y) %>%
    mutate(p_adj_fdr = case_when(
      is.na(.$p.value) == FALSE ~ p.adjust(.$p.value))) %>%
    select(summary_var, imm_cor, p_adj_fdr, everything()) %>%
    arrange(p_adj_fdr)
    })  
combined_spearman

combined_pearson <- map(combined_tbl, function(df){
  cor_tab <- var_pairs %>% 
    mutate(
      r_test = purrr::map2(
        x, y, 
        possibly(~ stats::cor.test(df[[.x]], df[[.y]], method = "pearson"),
          otherwise = data.frame())),
      r_test = purrr::map(r_test, tidy)
      ) %>%
    unnest(r_test) %>%
    dplyr::rename(summary_var = x, imm_cor = y) %>%
    mutate(p_adj_fdr = case_when(
      is.na(.$p.value) == FALSE ~ p.adjust(.$p.value))) %>%
    select(summary_var, imm_cor, p_adj_fdr, everything()) %>%
    arrange(p_adj_fdr)
    })  
combined_pearson

# write out results
write_xlsx(combined_spearman, "output/tcga_batchcorrected_correlations_spearman.xlsx")
write_xlsx(combined_pearson, "output/tcga_batchcorrected_correlations_pearson.xlsx")


# create global combined dataframe
combined_global <- imm_cor_combined_df %>%
  left_join(dervars_combined) %>%
  print()

global_cor_tab <- var_pairs %>% 
  mutate(
    r_test = purrr::map2(x, y, possibly(~ stats::cor.test(
      combined_global[[.x]],
      combined_global[[.y]], 
      method = "spearman"),
      otherwise = data.frame())),
    r_test = purrr::map(r_test, tidy)) %>%
  unnest(r_test) %>%
  dplyr::rename(summary_var = x, imm_cor = y) %>%
  mutate(p_adj_fdr = case_when(is.na(.$p.value) == FALSE ~ p.adjust(.$p.value))) %>%
  dplyr::select(summary_var, imm_cor, p_adj_fdr, everything()) %>%
  arrange(p_adj_fdr) 
global_cor_tab

write_xlsx(global_cor_tab, "output/tcga_global_batchcorrected_correlations_spearman.xlsx")
```

#### Plots of summary variables
```{r}
# get combined/single tibble
dervars_unified_tbl <- map(dervars_dfs, function(df){
  df %>%
    rownames_to_column(var = "tcga_barcode") %>%
    as_tibble()
}) %>% 
  enframe() %>%
  unnest(value) %>%
  dplyr::rename(tcga_proj = name) %>%
  print()

# make list of input variables from column names
# exclude tcga project and barcode
inputvars <- as.list(colnames(dervars_unified_tbl[3:ncol(dervars_unified_tbl)]))
names(inputvars) <- colnames(dervars_unified_tbl[3:ncol(dervars_unified_tbl)])
inputvars

# function for plot
### NOT WORKING YET
# map(inputvars, function(inputvar){
#  dervars_unified_tbl %>% 
#    ggplot(aes(x = reorder(tcga_proj, inputvar, mean), 
#             y = inputvar, 
#             fill = tcga_proj, 
#             color = tcga_proj)) +
#    geom_violin(scale = "width")
    # geom_boxplot(width = 0.15, fill = "white") +
    # theme_classic2() +
    # theme(legend.position = "none") +
    # theme(axis.text.x = element_text(angle = 60, hjust=1)) +
    # xlab("") +
    # ggtitle(paste0("Genus ", inputvar, " by tumor type"))
# })
  
dervars_unified_tbl %>% 
  ggplot(aes(x = reorder(tcga_proj, simpson, mean), y = simpson, fill = tcga_proj, color = tcga_proj)) +
  geom_violin(scale = "width") +
  geom_boxplot(width = 0.15, fill = "white") +
  theme_classic2() +
  theme(legend.position = "none") +
  theme(axis.text.x = element_text(angle = 60, hjust=1)) +
  xlab("") +
  ggtitle("Genus Simpson diversity by tumor type") + 
  expand_limits(x = 0, y = 0)

dervars_unified_tbl %>% 
  ggplot(aes(x = reorder(tcga_proj, invsimpson, mean), 
             y = invsimpson, 
             fill = tcga_proj, 
             color = tcga_proj)) +
  geom_violin(scale = "width") +
  geom_boxplot(width = 0.15, fill = "white") +
  theme_classic2() +
  theme(legend.position = "none") +
  theme(axis.text.x = element_text(angle = 60, hjust=1)) +
  xlab("") +
  ggtitle("Genus inverse Simpson diversity by tumor type") +
  expand_limits(x = 0, y = 0)

dervars_unified_tbl %>% 
  ggplot(aes(x = reorder(tcga_proj, pielou_evenness, mean), 
             y = pielou_evenness, 
             fill = tcga_proj, 
             color = tcga_proj)) +
  geom_violin(scale = "width") +
  geom_boxplot(width = 0.15, fill = "white") +
  theme_classic2() +
  theme(legend.position = "none") +
  theme(axis.text.x = element_text(angle = 60, hjust=1)) +
  xlab("") +
  ggtitle("Genus Pielou evenness by tumor type") +
  expand_limits(x = 0, y = 0)

dervars_unified_tbl %>% 
  ggplot(aes(x = reorder(tcga_proj, rar_rich, mean), 
             y = rar_rich, 
             fill = tcga_proj, 
             color = tcga_proj)) +
  geom_violin(scale = "width") +
  geom_boxplot(width = 0.15, fill = "white") +
  theme_classic2() +
  theme(legend.position = "none") +
  theme(axis.text.x = element_text(angle = 60, hjust=1)) +
  xlab("") +
  ggtitle("Genus rarified richness by tumor type")

dervars_unified_tbl %>% 
  ggplot(aes(x = reorder(tcga_proj, rar_rich, mean), 
             y = rar_rich, 
             fill = tcga_proj, 
             color = tcga_proj)) +
  geom_violin(scale = "width") +
  geom_boxplot(width = 0.15, fill = "white") +
  theme_classic2() +
  theme(legend.position = "none") +
  theme(axis.text.x = element_text(angle = 60, hjust=1)) +
  xlab("") +
  ggtitle("Genus rarified richness by tumor type")

dervars_unified_tbl %>% 
  ggplot(aes(x = reorder(tcga_proj, viruses, mean), 
             y = viruses, 
             fill = tcga_proj, 
             color = tcga_proj)) +
  geom_violin(scale = "width") +
  geom_boxplot(width = 0.15, fill = "white") +
  theme_classic2() +
  theme(legend.position = "none") +
  theme(axis.text.x = element_text(angle = 60, hjust=1)) +
  xlab("") +
  ggtitle("Viral cpm by tumor")

dervars_unified_tbl %>% 
  ggplot(aes(x = reorder(tcga_proj, archaea, mean), 
             y = archaea, 
             fill = tcga_proj, 
             color = tcga_proj)) +
  geom_violin(scale = "width") +
  geom_boxplot(width = 0.15, fill = "white") +
  theme_classic2() +
  theme(legend.position = "none") +
  theme(axis.text.x = element_text(angle = 60, hjust=1)) +
  xlab("") +
  ggtitle("Archaea CPM by tumor")

dervars_unified_tbl %>% 
  ggplot(aes(x = reorder(tcga_proj, bacteria, mean), 
             y = bacteria, 
             fill = tcga_proj, 
             color = tcga_proj)) +
  geom_violin(scale = "width") +
  geom_boxplot(width = 0.15, fill = "white") +
  theme_classic2() +
  theme(legend.position = "none") +
  theme(axis.text.x = element_text(angle = 60, hjust=1)) +
  xlab("") +
  ggtitle("Bacteria CPM by tumor")

dervars_unified_tbl %>% 
  ggplot(aes(x = reorder(tcga_proj, bacteria, mean), 
             y = log(bacteria), 
             fill = tcga_proj, 
             color = tcga_proj)) +
  geom_violin(scale = "width") +
  geom_boxplot(width = 0.15, fill = "white") +
  theme_classic2() +
  theme(legend.position = "none") +
  theme(axis.text.x = element_text(angle = 60, hjust=1)) +
  xlab("") +
  ggtitle("Bacteria log(CPM) by tumor")

dervars_unified_tbl %>% 
  ggplot(aes(x = reorder(tcga_proj, eukaryota, mean), 
             y = eukaryota, 
             fill = tcga_proj, 
             color = tcga_proj)) +
  geom_violin(scale = "width") +
  geom_boxplot(width = 0.15, fill = "white") +
  theme_classic2() +
  theme(legend.position = "none") +
  theme(axis.text.x = element_text(angle = 60, hjust=1)) +
  xlab("") +
  ggtitle("Eukaryota CPM by tumor")

dervars_unified_tbl %>% 
  ggplot(aes(x = reorder(tcga_proj, microbial_cpm, mean), 
             y = microbial_cpm, 
             fill = tcga_proj, 
             color = tcga_proj)) +
  geom_violin(scale = "width") +
  geom_boxplot(width = 0.15, fill = "white") +
  theme_classic2() +
  theme(legend.position = "none") +
  theme(axis.text.x = element_text(angle = 60, hjust=1)) +
  xlab("") +
  ggtitle("Any microbial CPM by tumor")

dervars_unified_tbl %>% 
  ggplot(aes(x = reorder(tcga_proj, frac_viruses, mean), 
             y = frac_viruses, 
             fill = tcga_proj, 
             color = tcga_proj)) +
  geom_violin(scale = "width") +
  geom_boxplot(width = 0.15, fill = "white") +
  theme_classic2() +
  theme(legend.position = "none") +
  theme(axis.text.x = element_text(angle = 60, hjust=1)) +
  xlab("") +
  ggtitle("Fraction of viral CPM by tumor")

dervars_unified_tbl %>% 
  ggplot(aes(x = reorder(tcga_proj, frac_archaea, mean), 
             y = frac_archaea, 
             fill = tcga_proj, 
             color = tcga_proj)) +
  geom_violin(scale = "width") +
  geom_boxplot(width = 0.15, fill = "white") +
  theme_classic2() +
  theme(legend.position = "none") +
  theme(axis.text.x = element_text(angle = 60, hjust=1)) +
  xlab("") +
  ggtitle("Fraction of archaea CPM by tumor")

dervars_unified_tbl %>% 
  ggplot(aes(x = reorder(tcga_proj, frac_bacteria, mean), 
             y = frac_bacteria, 
             fill = tcga_proj, 
             color = tcga_proj)) +
  geom_violin(scale = "width") +
  geom_boxplot(width = 0.15, fill = "white") +
  theme_classic2() +
  theme(legend.position = "none") +
  theme(axis.text.x = element_text(angle = 60, hjust=1)) +
  xlab("") +
  ggtitle("Fraction of bacteria CPM by tumor")

dervars_unified_tbl %>% 
  ggplot(aes(x = reorder(tcga_proj, frac_eukaryota, mean), 
             y = frac_eukaryota, 
             fill = tcga_proj, 
             color = tcga_proj)) +
  geom_violin(scale = "width") +
  geom_boxplot(width = 0.15, fill = "white") +
  theme_classic2() +
  theme(legend.position = "none") +
  theme(axis.text.x = element_text(angle = 60, hjust=1)) +
  xlab("") +
  ggtitle("Fraction of eukaryote CPM by tumor")
```

#### Plots of correlates of summary variables
```{r}
map(combined_spearman, function(df){
  df %>%
    dplyr::filter(p_adj_fdr < 0.1)
})

# Will first look at melanoma given CBT trial analysis
combined_pearson$SKCM %>% arrange(p_adj_fdr) %>% slice(1:3) %>% View()

combined_tbl %>% 
  .[["SKCM"]] %>%
  dplyr::select(eukaryota, stromal_fraction = `Stromal Fraction`) %>%
  ggplot(aes(x = eukaryota, y = stromal_fraction)) +
    geom_point() +
    geom_smooth() +
    ggtitle("Melanoma stromal fraction vs eukaryota")

combined_tbl %>% 
  .[["SKCM"]] %>%
  dplyr::select(frac_bacteria, plasma_cells = `Plasma Cells`) %>%
  ggplot(aes(x = frac_bacteria, y = plasma_cells)) +
    geom_point() +
    geom_smooth() +
    ggtitle("Melanoma plasma cells vs bacterial fraction")
```


## Genus correlations
```{r}
# genera for correlation
genera_names <- genus_analysis_list$genus_cpm_list %>%
  # drop variables not assigned to a genus
  map(~ .[(-which(colnames(.) == "---"))]) %>%
  # get colnames for comparisons
  map(~ .[(-which(colnames(.) == "tcga_barcode"))]) %>%
  .[[1]] %>%
  colnames(.)

# read in corrected genus level data
corrected_es <- readRDS("output/corrected_genus_cpm_expressionset.rds")

# immune correlates for correlation
imm_cor_names <- combined_tbl %>%
  # get colnames for comparisons
  map(~ .[(-which(colnames(.) == "tcga_barcode"))]) %>%
  .[[1]] %>%
  colnames(.)

# make comparison table
var_pairs <- map(genera_names, function(genus_name){
  enframe(imm_cor_names) %>%
    bind_cols(rep(genus_name, times = nrow(.))) %>%
    select(imm_cor = value, genus = `...3`)
}) %>%
  bind_rows() %>%
  print()

# make table of data for correlations
cpm_unified_df <- genus_analysis_list$genus_cpm_list %>%
  enframe() %>%
  unnest(value) %>%
  rename(tcga_proj = name)
combined_unified_df <- combined_tbl %>%
  enframe() %>%
  unnest(value) %>%
  rename(tcga_proj = name)
unified_list <- combined_unified_df %>%
  left_join(cpm_unified_df) %>%
  nest(-tcga_proj) %>%
  deframe() %>%
  print()

# get correlations
genus_pearson <- map(unified_list, function(df){
  cor_tab <- var_pairs %>% 
    mutate(
      r_test = purrr::map2(
        imm_cor, genus, 
        possibly(~ stats::cor.test(df[[.x]], df[[.y]], method = "pearson"),
          otherwise = data.frame())),
      r_test = purrr::map(r_test, tidy)) %>%
    unnest(r_test) %>%
    mutate(p_adj_fdr = case_when(
      is.na(.$p.value) == FALSE ~ p.adjust(.$p.value))) %>%
    dplyr::select(imm_cor, genus, estimate, p_adj_fdr, p.value, everything())
  })

# split out summary variables
sumvars <- colnames(dervars_dfs[[1]])
genus_pearson_dervars_trim <- genus_pearson %>%
  map(~ filter(., imm_cor %in% sumvars)) %>%
  map(~ arrange(., p_adj_fdr)) %>%
  print()
# save for later analysis
saveRDS(genus_pearson_dervars_trim, "output/genus_sumvar_correlations_pearson.rds")

# split out immune correlates
imvars <- colnames(imm_cor_dfs[[1]])
genus_pearson_immune_trim <- genus_pearson %>%
  map(~ filter(., imm_cor %in% imvars)) %>%
  map(~ arrange(., p_adj_fdr)) %>%
  print()
# write excel spreadsheet
saveRDS(genus_pearson_immune_trim, "output/genus_immune_correlations_pearson.rds")

# immune correlations for display
genus_pearson_immune_trim %>%
  map(., ~ .[1:200, ]) %>%
  # remove tables with missing data
  .[-(which(names(.) == "UVM"))] %>%
  .[-(which(names(.) == "PAAD"))] %>%
  write_xlsx(., "output/display_genus_immune_correlations_pearson.xlsx")

# get spearman correlations
genus_spearman <- map(unified_list, function(df){
  cor_tab <- var_pairs %>% 
    mutate(
      r_test = purrr::map2(
        imm_cor, genus, 
        possibly(~ stats::cor.test(df[[.x]], df[[.y]], method = "spearman"),
          otherwise = data.frame())),
      r_test = purrr::map(r_test, tidy)) %>%
    unnest(r_test) %>%
    mutate(p_adj_fdr = case_when(
      is.na(.$p.value) == FALSE ~ p.adjust(.$p.value))) %>%
    dplyr::select(imm_cor, genus, estimate, p_adj_fdr, p.value, everything())
  })

# split out summary variables
sumvars <- colnames(dervars_dfs[[1]])
genus_spearman_dervars_trim <- genus_spearman %>%
  map(~ filter(., imm_cor %in% sumvars)) %>%
  map(~ arrange(., p_adj_fdr)) %>%
  print()
# save for later analysis
saveRDS(genus_spearman_dervars_trim, "output/genus_sumvar_correlations_spearman.rds")
write_xlsx(genus_spearman_dervars_trim, "output/display_genus_summary_correlations_spearman.xlsx")

# split out immune correlates
imvars <- colnames(imm_cor_dfs[[1]])
genus_spearman_immune_trim <- genus_spearman %>%
  map(~ filter(., imm_cor %in% imvars)) %>%
  map(~ arrange(., p_adj_fdr)) %>%
  print()
# save for later analysis
saveRDS(genus_spearman_immune_trim, "output/genus_immune_correlations_spearman.rds")

# immune correlations for display
genus_spearman_immune_trim %>%
  map(., ~ .[1:200, ]) %>%
  # remove tables with missing data
  .[-(which(names(.) == "UVM"))] %>%
  .[-(which(names(.) == "PAAD"))] %>%
  write_xlsx(., "output/display_genus_immune_correlations_spearman.xlsx")

```

#### Immune correlate heatmaps

Alternate start site
```{r}
# read in data
genus_spearman_immune_trim <- readRDS("output/genus_immune_correlations_spearman.rds")

genus_spearman_immune_select <- genus_spearman_immune_trim %>%
  # remove studies with too much missing data
  .[-(which(names(.) == "UVM"))] %>%
  .[-(which(names(.) == "PAAD"))]
df <- genus_spearman_immune_select[[1]]

### PROBLEM: should I be selecting the most variance in CORRELATIONS?
### why do some of these heatmaps fail? selecting most variance?
### doesn't work if all genera included
genus_spearman_hm_list <- map(genus_spearman_immune_select, function(df){
  df %>% 
    dplyr::select(imm_cor, genus, estimate) %>%
    pivot_wider(names_from = imm_cor, values_from = estimate) %>%
    rowwise %>% 
    mutate(variance = c_across(-genus) %>% var()) %>% 
    ungroup() %>% 
    slice_max(n = 100, order_by = variance) %>%
    dplyr::select(-variance) %>%
    as.data.frame() %>%
    column_to_rownames(var = "genus") %>%
    as.matrix() %>%
    Heatmap(., name = "Scaled\nSpearman\ncorrelation")
})

# save the heatmaps
for (hm in names(genus_spearman_hm_list)){
  png(paste0("plots/heatmap_", hm, ".png"), 
      width = 12, 
      height = 18, 
      units = "in", res = 100)
  draw(genus_spearman_hm_list[[hm]],
      column_title = hm, 
      column_title_gp = gpar(fontsize = 36, fontface = "bold"))
  dev.off()
}

STAD <- genus_spearman_immune_trim[["STAD"]] %>%
  dplyr::mutate(imm_cor = ifelse(imm_cor == "Lymphocyte Infiltration Signature Score", "Lymphocyte Infiltration", imm_cor)) %>%
  dplyr::mutate(imm_cor = ifelse(imm_cor == "Homologous Recombination Defects", "Hom. Recombination Defects", imm_cor)) %>%
  dplyr::filter(!imm_cor == "invsimpson") %>%
  dplyr::filter(!imm_cor == "Fraction Altered") %>%
  dplyr::filter(!imm_cor == "Number of Segments") %>%
  dplyr::select(imm_cor, genus, estimate) %>%
  pivot_wider(names_from = imm_cor, values_from = estimate) %>%
    rowwise %>% 
    mutate(variance = c_across(-genus) %>% var()) %>% 
    ungroup() %>% 
    slice_max(n = 100, order_by = variance) %>%
    dplyr::select(-variance) %>%
    as.data.frame() %>%
    column_to_rownames(var = "genus") %>%
    as.matrix() %>%
    Heatmap(., name = "Scaled\nSpearman\ncorrelation")

STAD <- genus_spearman_immune_trim[["STAD"]] %>%
  dplyr::mutate(imm_cor = ifelse(imm_cor == "Lymphocyte Infiltration Signature Score", "Lymphocyte Infiltration", imm_cor)) %>%
  dplyr::mutate(imm_cor = ifelse(imm_cor == "Homologous Recombination Defects", "Hom. Recombination Defects", imm_cor)) %>%
  dplyr::filter(!imm_cor == "invsimpson") %>%
  dplyr::filter(!imm_cor == "Fraction Altered") %>%
  dplyr::filter(!imm_cor == "Number of Segments") %>%
  dplyr::select(imm_cor, genus, estimate) %>%
  pivot_wider(names_from = imm_cor, values_from = estimate) %>%
    rowwise %>% 
    mutate(variance = c_across(-genus) %>% var()) %>% 
    ungroup() %>% 
    slice_max(n = 100, order_by = variance) %>%
    dplyr::select(-variance) %>%
    as.data.frame() %>%
    column_to_rownames(var = "genus") %>%
    as.matrix() %>%
    Heatmap(., name = "Scaled\nSpearman\ncorrelation")

SKCM <- genus_spearman_immune_trim[["SKCM"]] %>%
  dplyr::mutate(imm_cor = ifelse(imm_cor == "Lymphocyte Infiltration Signature Score", "Lymphocyte Infiltration", imm_cor)) %>%
  dplyr::mutate(imm_cor = ifelse(imm_cor == "Homologous Recombination Defects", "Hom. Recombination Defects", imm_cor)) %>%
  dplyr::filter(!imm_cor == "invsimpson") %>%
  dplyr::filter(!imm_cor == "Fraction Altered") %>%
  dplyr::filter(!imm_cor == "Number of Segments") %>%
  dplyr::select(imm_cor, genus, estimate) %>%
  pivot_wider(names_from = imm_cor, values_from = estimate) %>%
    rowwise %>% 
    mutate(variance = c_across(-genus) %>% var()) %>% 
    ungroup() %>% 
    slice_max(n = 100, order_by = variance) %>%
    dplyr::select(-variance) %>%
    as.data.frame() %>%
    column_to_rownames(var = "genus") %>%
    as.matrix() %>%
    Heatmap(., name = "Scaled\nSpearman\ncorrelation")
```

```{r}
### Top immune correlates for selected genera
genus_select_spearman_barplots <- genus_spearman_immune_select %>% 
  map(~ dplyr::filter(., genus %in% c("Bacillus", 
                                      "Aerococcus", 
                                      "Enterocloster", 
                                      "Corynebacterium", 
                                      "Prevotella", 
                                      "Helicobacter"))) %>%
  map(~ ggplot(., aes(y = estimate, x = as.factor(imm_cor), fill = genus)) + 
        geom_bar(stat = "identity", position = position_dodge()) +
        theme_minimal() +
        theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
        ylab("Spearman correlation") +
        xlab("")
      )

# save plots
for (bp in names(genus_select_spearman_barplots)){
  p <- genus_select_spearman_barplots[[bp]] + ggtitle(bp)
  png(paste0("plots/select_barplot_", bp, ".png"), 
      width = 12, 
      height = 5, 
      units = "in", res = 200)
  print(p)
  dev.off()
}
```

#### Genera that differed most between melanoma responders and nonresponders
```{r}
# get dataframe of raw counts and immune correlates for plotting
sel_gen <- c("Bacillus", "Aerococcus", "Enterocloster", "Corynebacterium", "Prevotella", "Helicobacter")

imm_correlates <- unified_list %>%
  enframe() %>%
  unnest(value) %>%
  select(one_of("name", (colnames(genus_analysis_list$imm_cor[[1]])))) %>%
  dplyr::rename(tcga_proj = name) %>%
  print()
  
selected_genera <- unified_list %>%
  enframe() %>%
  unnest(value) %>%
  select(one_of(c("name", "tcga_barcode", sel_gen))) %>%
  dplyr::rename(tcga_proj = name) %>%
  dplyr::select(tcga_proj, tcga_barcode, one_of(sel_gen)) %>%
  pivot_longer(one_of(sel_gen)) %>%
  dplyr::rename(cpm = value, genus = name) %>%
  dplyr::mutate(tcga_proj = as.factor(tcga_proj)) %>%
  print()

abundance_plot <- selected_genera %>%
  ggplot(aes(y = cpm, x = tcga_proj, fill = genus)) +
    geom_bar(stat = "identity", position = position_dodge()) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
    xlab("") +
    ggtitle("Abundances of selected genera")
abundance_plot

log_abundance_plot <- selected_genera %>%
  ggplot(aes(y = log(cpm), x = tcga_proj, fill = genus)) +
    geom_violin() +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 90)) +
    xlab("") +
    ggtitle("Abundances of selected genera") +
    ylim(0, 18)
log_abundance_plot

skcm_gen_cors <- selected_genera %>%
  left_join(imm_correlates) %>% 
  # remove projects with too much missing data
  dplyr::filter(tcga_proj == "SKCM") %>%
  print()

# get most significant correlations for the selected genera
sig_cor <- genus_pearson_immune_trim %>%
  enframe() %>%
  unnest(value) %>%
  rename(tcga_proj = name) %>%
  dplyr::filter(genus %in% sel_gen) %>%
  dplyr::filter(tcga_proj == "SKCM") %>%
  arrange(p_adj_fdr) %>%
  print()

# plots
ggplot(skcm_gen_cors, aes(x = Enterocloster, y = `IFN-gamma Response`)) +
  geom_point() +
  geom_smooth(method = "lm", color = "red") +
  ggtitle("SKCM genus cpm vs immune correlate score") +
  annotate("text", x = 50000, y = 2.5, label = "p.adj = 1.27e-7") +
  theme_minimal() 

ggplot(skcm_gen_cors, aes(x = Enterocloster, y = `TCR Richness`)) +
  geom_point() +
  geom_smooth(method = "lm", color = "red") +
  ggtitle("SKCM genus cpm vs immune correlate score") +
  annotate("text", x = 50000, y = 60, label = "p.adj = 1.82e-07") +
  theme_minimal() 

ggplot(skcm_gen_cors, aes(x = Enterocloster, y = `Lymphocyte Infiltration Signature Score`)) +
  geom_point() +
  geom_smooth(method = "lm", color = "red") +
  ggtitle("SKCM genus cpm vs immune correlate score") +
  annotate("text", x = 50000, y = 2.5, label = "p.adj = 2.62e-06") +
  theme_minimal() 

ggplot(skcm_gen_cors, aes(x = Enterocloster, y = `TCR Shannon`)) +
  geom_point() +
  geom_smooth(method = "lm", color = "red") +
  ggtitle("SKCM genus cpm vs immune correlate score") +
  annotate("text", x = 50000, y = 5, label = "p.adj = 5.08e-06") +
  theme_minimal() 

ggplot(skcm_gen_cors, aes(x = Enterocloster, y = `Macrophage Regulation`)) +
  geom_point() +
  geom_smooth(method = "lm", color = "red") +
  ggtitle("SKCM genus cpm vs immune correlate score") +
  annotate("text", x = 50000, y = 1.2, label = "p.adj = 8.15e-06") +
  theme_minimal() 

ggplot(skcm_gen_cors, aes(x = Enterocloster, y = `T Cells CD8`)) +
  geom_point() +
  geom_smooth(method = "lm", color = "red") +
  ggtitle("SKCM genus cpm vs immune correlate score") +
  annotate("text", x = 50000, y = 0.5, label = "p.adj = 1.43e-03") +
  theme_minimal() 
```

#### Scatterplots for immune correlates  
```{r}
# get immune correlate with sample name
# input is list by tcga project
# output is single flat table with tcga_project as a column
tcr_richness <- map(imcor_vars_list, function(imm_cor){
  imm_cor["TCR Richness"] %>%
    as.data.frame() %>%
    rownames_to_column(var = "tcga_barcode") %>%
    as_tibble()
}) %>% 
  enframe() %>%
  unnest(value) %>%
  dplyr::rename(tcga_project = name) %>%
  print()

# use trimmed counts that correspond to cases with immune data
# trimmed for correlation analysis above
# input is list by tcga project
# output is single flat table with tcga_project as a column
enterocloster <- map(counts_trim, function(counts){
  counts["Enterocloster"] %>%
    as.data.frame() %>%
    rownames_to_column(var = "tcga_barcode") %>%
    as_tibble()
}) %>% 
  enframe() %>%
  unnest(value) %>%
  dplyr::rename(tcga_project = name) %>%
  print()

tcr_richness_vs_enterocloster <- tcr_richness %>%
  left_join(enterocloster) %>%
  dplyr::filter(!is.na(`TCR Richness`)) %>%
  dplyr::filter(!is.na(Enterocloster)) %>%
  dplyr::rename(tcr_richness = `TCR Richness`) %>%
  ggplot(aes(
      y = tcr_richness,
      x = Enterocloster)
    ) +
    geom_point(alpha = 0.2) +
    geom_smooth() +
    stat_cor(method = "spearman",
             cor.coef.name = "rho",
             label.y = 1000) +
    theme_classic2() +
    theme(legend.position = "none") +
    ylim(c(-1, 1050))
  
tcr_richness_vs_enterocloster

tcr_richness_vs_enterocloster_facet <- tcr_richness %>%
  left_join(enterocloster) %>%
  dplyr::filter(!is.na(`TCR Richness`)) %>%
  dplyr::filter(!is.na(Enterocloster)) %>%
  dplyr::rename(tcr_richness = `TCR Richness`) %>%
  ggplot(aes(
      y = tcr_richness,
      x = Enterocloster,
      color = tcga_project)
    ) +
    geom_point(alpha = 0.2) +
    geom_smooth() +
    stat_cor(method = "spearman",
             cor.coef.name = "rho",
             label.y = 1000) +
    facet_wrap(facets = "tcga_project") +
    theme_classic2() +
    theme(legend.position = "none")
  
tcr_richness_vs_enterocloster_facet

#-----------------------------------------
tgf_beta <- map(imcor_vars_list, function(imm_cor){
  imm_cor["TGF-beta Response"] %>%
    as.data.frame() %>%
    rownames_to_column(var = "tcga_barcode") %>%
    as_tibble()
}) %>% 
  enframe() %>%
  unnest(value) %>%
  dplyr::rename(tcga_project = name) %>%
  print()

# use trimmed counts that correspond to cases with immune data
# trimmed for correlation analysis above
# input is list by tcga project
# output is single flat table with tcga_project as a column
orthopoxvirus <- map(counts_trim, function(counts){
  counts["Orthopoxvirus"] %>%
    as.data.frame() %>%
    rownames_to_column(var = "tcga_barcode") %>%
    as_tibble()
}) %>% 
  enframe() %>%
  unnest(value) %>%
  dplyr::rename(tcga_project = name) %>%
  print()

# plot "pancancer" scatter plot
tgf_beta_vs_orthopoxvirus <- tgf_beta %>%
  left_join(orthopoxvirus) %>%
  dplyr::filter(!is.na(`TGF-beta Response`)) %>%
  dplyr::filter(!is.na(Orthopoxvirus)) %>%
  ggplot(aes(
      y = `TGF-beta Response`,
      x = Orthopoxvirus)
    ) +
    geom_point(alpha = 0.2) +
    geom_smooth() +
    stat_cor(method = "spearman",
             cor.coef.name = "rho",
             label.y = 1.5) +
    theme_classic2() +
    theme(legend.position = "none")
  
tgf_beta_vs_orthopoxvirus

# scatterplot facet by tumor type
tgf_beta_vs_orthopoxvirus <- tgf_beta %>%
  left_join(orthopoxvirus) %>%
  dplyr::filter(!is.na(`TGF-beta Response`)) %>%
  dplyr::filter(!is.na(Orthopoxvirus)) %>%
  ggplot(aes(
      y = `TGF-beta Response`,
      x = Orthopoxvirus,
      color = tcga_project)
    ) +
    geom_point(alpha = 0.2) +
    geom_smooth() +
    stat_cor(method = "spearman",
             cor.coef.name = "rho",
             label.y = 1.5) +
    facet_wrap(facets = "tcga_project") +
    theme_classic2() +
    theme(legend.position = "none")
  
tgf_beta_vs_orthopoxvirus
```



## Clinical Outcomes

#### Clinical and immune variables modeled on genera

```{r}

# make list of clinical data
clindat_list <- genus_analysis_list$clindat

# ovarian cancer clinical data uses figo instead of AJCC staging
# infer nodal and metastatic status from figo staging
clindat_ov <- clindat_list[["OV"]] %>%
  mutate(ajcc_pathologic_t = rep(NA, nrow(.))) %>%
  mutate(ajcc_pathologic_n = ifelse(
    figo_stage %in% c("Stage IIIA", "Stage IIIB", "Stage IIIC", "Stage IVA", "Stage IVB"),
    1, 
    ifelse(is.na(figo_stage), NA, 0))) %>% 
  mutate(ajcc_pathologic_m = ifelse(
    figo_stage %in% c("Stage IVA", "Stage IVB"),
    1,
    ifelse(is.na(figo_stage), NA, 0))) %>%
  dplyr::select(figo_stage, ajcc_pathologic_t, ajcc_pathologic_n, ajcc_pathologic_m, everything()) 

# add repaired dataframe back to list
clindat_list[["OV"]] <- clindat_ov

# some tumors missing ajcc_pathologic_m and other tumor variables
# remove from list for now, will attempt repair later
clindat_list[["PCPG"]] <- NULL
clindat_list[["THYM"]] <- NULL
clindat_list[["UCS"]] <- NULL
clindat_list[["SARC"]] <- NULL

# function to make dataframe for clinical data
# all outcomes defined as binary (0/1) outcome
outcomes_cleaner <- function(clindat){
  # examine only primary tumors
  clindat_prime <- clindat %>%
    dplyr::filter(sample_type == "Primary Tumor")
  # define binary survival outcome variables
  surv_cols <- clindat_prime %>% 
    # examine only primary tumors
    dplyr::filter(sample_type == "Primary Tumor") %>%
    dplyr::select(tcga_barcode, days_to_death, days_to_last_follow_up) %>%
    mutate(
      os_status = ifelse(is.na(days_to_death), 0, 1)
      ) %>%
    mutate(
      os_days = ifelse(os_status == 1, days_to_death, days_to_last_follow_up)
      ) %>%
    dplyr::select(tcga_barcode, os_status, os_days) %>%
    mutate(
      twoyr_os_status = ifelse(os_status == 0, 0,
                              ifelse(os_days > 730, 0, 1))
      ) %>%
    mutate(
      fiveyr_os_status = ifelse(os_status == 0, 0,
                               ifelse(os_days > 1826, 0, 1))
      ) %>%
    dplyr::select(tcga_barcode, 
                  twoyr_os_status, 
                  fiveyr_os_status)
  # binary demographics variables
  demo_cols <- clindat_prime %>%
    dplyr::select(tcga_barcode, gender, age_at_index, race) %>%
    mutate(
      female_sex = ifelse(gender == "female", 1,
                          ifelse(is.na(gender), NA, 1))
      ) %>%
    mutate(
      older_adult = ifelse(age_at_index > 65, 1,
                           ifelse(is.na(age_at_index), NA, 1))
      ) %>%
    mutate(
      nonwhite_race = ifelse(race == "white", 0, 
                            ifelse(is.na(race), NA, 1))
      ) %>%
    dplyr::select(tcga_barcode, female_sex, older_adult, nonwhite_race) 
  # binary tumor variables
  tumor_cols <- clindat_prime %>%
    dplyr::select(tcga_barcode, 
                  tumor_stage, 
                  ajcc_pathologic_t,
                  ajcc_pathologic_m,
                  ajcc_pathologic_n) %>%
    mutate(
      stage_iv = ifelse(grepl("iv", tumor_stage), 1,
                          ifelse(tumor_stage == "not reported", NA, 
                                        ifelse(is.na(tumor_stage), NA, 1)))
           ) %>%
    mutate(
      t4 = ifelse(grepl("4", ajcc_pathologic_t), 1,
                          ifelse(ajcc_pathologic_t == "TX", NA,
                                        ifelse(is.na(ajcc_pathologic_t), NA, 1)))
    ) %>%
    mutate(
      metastatic = ifelse(ajcc_pathologic_m == "M1", 1, 
                          ifelse(ajcc_pathologic_m == "MX", NA,
                                        ifelse(is.na(ajcc_pathologic_m), NA, 1)))
    ) %>%
    mutate(
      nodal_involvement = ifelse(ajcc_pathologic_n == "N0", 0,
                                 ifelse(ajcc_pathologic_n == "NX", NA, 
                                        ifelse(is.na(ajcc_pathologic_n), NA, 1)))
    ) %>%
    dplyr::select(tcga_barcode, stage_iv, t4, metastatic, nodal_involvement)
  surv_cols %>%
    left_join(demo_cols) %>%
    left_join(tumor_cols)
}
  
outcomes_data <- map(clindat_list, outcomes_cleaner)
  
```

Interesting nonbinary clinical variables:
* primary_diagnosis
* tissue_or_organ_of_origin
* site_of_resection_or_surgery




## PCA plots
```{r}
genus_for_pca <- counts_tbl_list %>%
  reduce(bind_rows) %>%
  as.data.frame() %>%
  column_to_rownames(var = "tcga_barcode")

set.seed(818)

genus_pca <- PCA(genus_for_pca, scale.unit = TRUE,  ncp = 10, graph = FALSE)
fviz_pca_var(genus_pca, col.var = "cos2",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"), 
             label = FALSE
             )
# Contributions of variables to PC1
fviz_contrib(genus_pca, choice = "var", axes = 1, top = 10)
# Contributions of variables to PC2
fviz_contrib(genus_pca, choice = "var", axes = 2, top = 10)

# labeled PCA
fviz_pca_ind(genus_pca)
```

Remove outliers
```{r}
genus_pca$ind$coord %>% as.data.frame %>% rownames_to_column(var = "tcga_barcode") %>% as_tibble() %>% arrange(Dim.2)

genus_pca$ind$coord %>% as.data.frame %>% rownames_to_column(var = "tcga_barcode") %>% as_tibble() %>% arrange(desc(Dim.2))

counts_filt <- counts_tbl_list %>%
  reduce(bind_rows) %>%
  dplyr::filter(!tcga_barcode %in% c("TCGA-B0-5702", "TCGA-VQ-A8P5", "TCGA-A7-A13E")) %>%
  as.data.frame() %>%
  column_to_rownames(var = "tcga_barcode") 

dim(counts_filt)
dim(genus_for_pca)

genus_pca_filt <- PCA(counts_filt, scale.unit = TRUE, ncp = 10, graph = FALSE)
fviz_pca_ind(genus_pca_filt)
fviz_pca_var(genus_pca_filt, col.var = "cos2",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"), 
             label = FALSE
             )
```



