---
title: "derive_vars"
author: "Michael Leukam"
date: "2021-02-03"
output: 
  workflowr::wflow_html
  html_notebook
editor_options:
  chunk_output_type: console
---
## Setup
Clear the workspace and set seed
```{r}
rm(list=ls())
set.seed(818)
```


Read in packages
```{r}
library(Biobase)
library(vegan)
library(Matrix.utils)
library(tidyverse)
library(ggpubr)
```

```{r}
knitr::opts_chunk$set(eval = FALSE)
```

Read in data
From tcga_data_prep
```{r}
# tcga_counts <- readRDS("data/comb_tcga_counts_list.rds")

# mode 2 data
tcga_counts <- readRDS("data/mode2_tcga_counts_list.rds")

str(tcga_counts, max.level = 2)
genus_tbl <- tcga_counts$counts$genus$STAD %>%
  print()
imm_cor_tbl <- tcga_counts$imm_cor$STAD %>%
  print()

# cleaned and batch corrected data
genus_es <- readRDS("corrected_genus_cpm_expressionset.rds")
```

```{bash}
sshfs mjl62@o2.hms.harvard.edu:/n/scratch3/users/m/mw292/AGAMEMNON/TCGA/Results/ ~/sshfs_mount/TCGA

cd ~/sshfs_mount/TCGA/TCGA_STAD/7c564146-979c-4b3d-9a0d-b9a1e0d07ca2/Analysis/7c564146-979c-4b3d-9a0d-b9a1e0d07ca2/taxonomic_ranks
```

```{r}
taxonomy <- read_csv("data/tcga_proj_taxonomy.csv")
```

Goal:
% microbial vs total reads
% microbial vs uniquely mapped on human reads
% viral (as above)
bacteria vs microbes
Number of different species
Genera, species, strains per million reads mapped on human
Genera, species, strain diversity and distribution descriptors (Shannon, Simpson, etc)
Genera abundance, species abundance, and strain abundance as correlates

## Descriptive Statistics

#### Distribution
```{r}
# get sublists of counts for downstream application
genus_list <- tcga_counts$counts$genus
species_list <- tcga_counts$counts$species
taxid_list <- tcga_counts$counts$taxid
kingdom_list <- tcga_counts$counts$kingdom
phylum_list <- tcga_counts$counts$phylum

genus_cpm_list <- tcga_counts$cpm_counts$genus_cpm
species_cpm_list <- tcga_counts$cpm_counts$species_cpm
taxid_cpm_list <- tcga_counts$cpm_counts$taxid_cpm
kingdom_cpm_list <- tcga_counts$cpm_counts$kingdom_cpm
phylum_cpm_list <- tcga_counts$cpm_counts$phylum_cpm

# batch corrected dataset
genus_cpm_clindat <- pData(genus_es) %>% 
  rownames_to_column(var = "tcga_barcode") %>%
  as_tibble() %>%
  print()
proj_lookup <- genus_cpm_clindat %>%
  select(tcga_barcode, tcga_proj) %>%
  print()
genus_cpm_corrected <- exprs(genus_es) %>%
  t() %>%
  print() %>%
  as.data.frame() %>%
  rownames_to_column(var = "tcga_barcode") %>%
  as_tibble() %>%
  left_join(proj_lookup) %>%
  select(tcga_proj, tcga_barcode, everything()) %>%
  group_by(tcga_proj) %>%
  nest() %>%
  deframe() %>%
  print()
```

Visualize distributions
```{r}
# make tidy dataframe for plotting
# run this on the genus corrected sublist
tidy_generator <- function(listelement){
  listelement %>% 
    pivot_longer(-tcga_barcode, names_to = "genus", values_to = "counts") %>%
    arrange(desc(counts))
}
# make tidy frames with cpm
tidy_genera <- map(genus_cpm_corrected, tidy_generator)

# counts distribution
counts_dist_plotter <- function(df){
  plot <- df %>%
    ggplot(aes(x = counts, color = tcga_barcode)) +
      geom_density() +
      theme(legend.position = "none")
  
}
# plot raw distributions of cpm for each tumor type
dist_plot_list <- map(tidy_genera, counts_dist_plotter)
do.call(ggarrange, dist_plot_list) %>%
  annotate_figure(., top = text_grob("Counts Distribution by Genus", color = "black", face = "bold", size = 14))
          
# log cpm distribution
log_dist_plotter <- function(df){
  plot <- df %>%
    mutate(lcounts = log(counts)) %>%
    dplyr::filter(lcounts > -100) %>%
    ggplot(aes(x = lcounts), color = tcga_barcode) +
      geom_density() +
      theme(legend.position = "none") +
      expand_limits(x = c(-20, 30))
}
# log cpm density plots
log_plot_list <- map(tidy_genera, log_dist_plotter)
names(log_plot_list) <- names(tidy_genera)
do.call(ggarrange, log_plot_list) %>%
  annotate_figure(., top = text_grob("log(Counts) Distribution by Genus", color = "black", face = "bold", size = 14))
```

## Derive new variables

#### Alpha diversity

```{r}
# get cpm in matrix form 
make_counts_df <- function(df){
  df %>%
    dplyr::group_by(tcga_barcode) %>%
    summarise_all(sum) %>%
    filter(across(everything(), ~ !is.nan(.x))) %>%
    as.data.frame() %>%
    column_to_rownames(var = "tcga_barcode")
}
genus_df_list <- map(genus_cpm_list, make_counts_df)
# species_df_list <- map(species_cpm_list, make_counts_df)
# taxid_df_list <- map(taxid_cpm_list, make_counts_df)

genus_corrected_df_list <- map(genus_cpm_corrected, make_counts_df)

df <- genus_df_list$BRCA 
# get measures of alpha-diversity
alpha_getter <- function(df){
  # get basic diversity indices
  shannon <- df %>% 
    diversity(., index = "shannon") %>%
    enframe() %>%
    rename(shannon = value)
  simpson <- df %>%
    diversity(., index = "simpson") %>%
    enframe() %>%
    rename(simpson = value)
  invsimpson <- df %>%
    diversity(., index = "invsimpson") %>%
    enframe() %>%
    rename(invsimpson = value)
  # get pielou evenness measure
  shanvect <- df %>%
    diversity(., index = "shannon")
  pielou <- tibble::enframe(shanvect/log(specnumber(df))) %>%
    rename(pielou_evenness = value)
  # get rarefied richness
  df_round <- df %>%
    as.matrix() %>%
    round(., digits = 0)
  rar <- rarefy(df_round, min(rowSums(df_round), na.rm = T)) %>%
    enframe() %>%
    rename(rar_rich = value)
  # join columns in single tbl
  alpha_df <- shannon %>%
    left_join(simpson, by = "name") %>%
    left_join(invsimpson, by = "name") %>%
    left_join(pielou, by = "name") %>%
    left_join(rar, by = "name") %>%
    dplyr::rename(tcga_barcode = name)
}

genus_alpha <- map(genus_df_list, alpha_getter)
# species_alpha <- map(species_df_list, alpha_getter)
# taxid_alpha <- map(taxid_df_list, alpha_getter)

genus_corrected_alpha <- map(genus_corrected_df_list, alpha_getter)
```

#### High-level taxonomy
```{r}
# read in repaired toxonomy
taxonomy_nomissing <- readRDS("data/tcga_proj_taxonomy_nomissing.rds")
# problem - Tissierella_Class is still called ---_Class
taxonomy_nomissing <- taxonomy_nomissing %>% 
  mutate(Genus = ifelse(Genus == 	"---_Class", "Tissierella_Class", Genus)) %>%
  arrange(Genus) %>%
  print()

# repair counts not generated with repaired toxonomy
kingdom_list_element <- tcga_counts$cpm_counts$kingdom_cpm$ACC

high_leveler <- function(kingdom_list_element){
  fractional_kingdom <- kingdom_list_element %>%
    dplyr::rename(viral = `---`, archaea = Archaea, 
                  bacteria = Bacteria, 
                  eukaryota = Eukaryota) %>%
    mutate(total_cpm = viral + archaea + bacteria + eukaryota) %>%
    mutate(across(-c(tcga_barcode, total_cpm), ~ . / total_cpm, .names = "frac_{.col}")) %>%
    dplyr::rename(microbe_cpm = total_cpm)
}

# apply function
kingdom_list <- tcga_counts$counts$kingdom
high_level_vars <- map(kingdom_list, high_leveler)
names(high_level_vars) <- names(kingdom_list)
high_level_vars

# get high level taxonomy data for corrected genus CPM
kingdom_lookup <- taxonomy_nomissing %>%
  dplyr::select(Superkingdom, Genus) %>%
  print()

corrected_high_level_vars <- genus_corrected_df_list %>%
  map(~ as.matrix(.)) %>%
  map(~ t(.)) %>%
  map(~ as.data.frame(.)) %>%
  map(~ rownames_to_column(., var = "Genus")) %>%
  map(~ as_tibble(.)) %>%
  map(~ left_join(., kingdom_lookup, by = "Genus")) %>%
  map(~ select(., Superkingdom, everything())) %>%
  map(~ select(., -Genus)) %>%
  # check for NAs or other weird results
  map(~ arrange(., Superkingdom)) %>%
  map(~ group_by(., Superkingdom)) %>%
  map(~ summarise_all(., sum)) %>%
  map(~ as.data.frame(.)) %>%
  map(~ column_to_rownames(., var = "Superkingdom")) %>%
  map(~ as.matrix(.)) %>%
  map(~ t(.)) %>%
  map(~ as.data.frame(.)) %>%
  map(~ rownames_to_column(., var = "tcga_barcode")) %>%
  map(~ as_tibble(.)) %>%
  map(~ select(., 
    tcga_barcode, 
    bacteria = Bacteria,
    viruses = Virus,
    archaea = Archaea,
    eukaryota = Eukaryota)) %>%
  map(~ mutate(., microbial_cpm = viruses + archaea + bacteria + eukaryota)) %>%
  map(~ mutate(., 
    across(-c(tcga_barcode, microbial_cpm), 
    ~ . / microbial_cpm, 
    .names = "frac_{.col}"))) %>%
  print()
```

## Write out results
```{r}
genus_analysis_list <- list("genus_cpm_list" = tcga_counts$counts$genus,
     "genus_alpha" = genus_alpha,
     "corrected_genus_alpha" = genus_corrected_alpha,
     "high_level_vars" = high_level_vars,
     "corrected_high_level_vars" = corrected_high_level_vars,
     "clindat" = tcga_counts$clindat,
     "imm_cor" = tcga_counts$imm_cor,
     "taxonomy" = taxonomy_nomissing)
saveRDS(genus_analysis_list, "data/genus_analysis_list.rds")
```


#### Beta diversity
```{r}


```
