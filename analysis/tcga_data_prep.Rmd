---
title: "tcga_data_prep"
author: "Michael Leukam"
date: "2020-09-12"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

## Setup

Clear the workspace and set seed
```{r}
rm(list=ls())
set.seed(818)
```

Load packages
```{r}
# data cleaning
library(tidyverse)
```

```{r}
knitr::opts_chunk$set(eval = FALSE)
```

Setup on local
```{bash, eval = FALSE}
sshfs mjl62@o2.hms.harvard.edu:/n/scratch3/users/m/mjl62 ~/sshfs_mount/TCGA

# get immune correlates
cd ~/sshfs_mount/TCGA/agamemnon_counts

curl https://contattafiles.s3.us-west-1.amazonaws.com/tnt40761/jOjcXzknipvEC1q/Characteristics.tsv > IMM_correlates.tsv
```

Load packages
```{r}
# data cleaning
library(tidyverse)
```

#### Read data and format
```{r}
# READ IN--------------------------------------------
# make list of TCGA projects
tcga_proj <- list("STAD" = "STAD",
                  "LUAD" = "LUAD",
                  "BRCA" = "BRCA",
                  "OV" = "OV",
                  "ESCA" = "ESCA",
                  "KIRK" = "KIRC",
                  "HNSC" = "HNSC")
# second batch
tcga_proj <- list("ACC" = "ACC",
                  "BLCA" = "BLCA",
                  "CESC" = "CESC",
                  "COAD" = "COAD",
                  "KICH" = "KICH",
                  "KIRP" = "KIRP",
                  "LAML" = "LAML",
                  "LIHC" = "LIHC",
                  "MESO" = "MESO",
                  "PAAD" = "PAAD",
                  "PCPG" = "PCPG",
                  "PRAD" = "PRAD",
                  "READ" = "READ",
                  "SARC" = "SARC",
                  "SKCM" = "SKCM",
                  "STAD" = "STAD",
                  "TGCT" = "TGCT",
                  "THCA" = "THCA",
                  "THYM" = "THYM",
                  "UCS" = "UCS",
                  "UVM" = "UVM")


# function to read in data for each project
file_loader <- function(tcga_proj){
  # assign path to data files
  path_to_directory <- "~/sshfs_mount/TCGA/agamemnon_counts/"
  # read in genus counts
  genus_counts <- read_csv(
  paste0(path_to_directory,
         tcga_proj, "_genus_counts.csv")
  )
   # read in species counts
  species_counts <- read_csv(
  paste0(path_to_directory, 
         tcga_proj, "_species_counts.csv")
  )
   # read in taxid counts
  taxid_counts <- read_csv(
    paste0(path_to_directory,
           tcga_proj, "_taxID_counts.csv")
  )
  # read in kingdom counts
  kingdom_counts <- read_csv(
    paste0(path_to_directory,
           tcga_proj, "_kingdom_counts.csv")
  )
  # read in clinical data
  clindat <- read_csv(
    paste0(path_to_directory, 
           tcga_proj, "_clindata.csv")
  ) %>%
    # keep only primary tumor data
    dplyr::filter(sample_type == "Primary Tumor") %>%
    # convert explicit attributes table to standard tbl
    # honestly because it is annoying for str() calls
    # and does not look pretty
    select(everything())
  # make counts tables into a list for batch processing
  counts <- list(genus_counts, species_counts, taxid_counts, kingdom_counts)
  names(counts) <- c("genus", "species", "taxid", "kingdom")
  # return a list of counts (nested) and clinical data
  combined_list <- list("counts" = counts, "clindat" = clindat)
  combined_list
}
# apply function to list
counts_clin_list <- purrr::map(tcga_proj, file_loader)

# FIX ROWNAMES--------------------------------------------
# function to convert file_ids to legacy TCGA barcodes
# using conversion columns in clindata
convert_to_barcodes <- function(list_as_element){
  clindat <- list_as_element[["clindat"]]
  imm_cor <- list_as_element[["imm_cor"]]
  
  lookup_table <- clindat %>% dplyr::select(file_id, tcga_barcode, sample_type)
  counts_tables <- list_as_element[["counts"]]
  counts_barcodes <- map(counts_tables, function(df){
    mat <- df[-1] %>%
      as.matrix()
    rownames(mat) <- df %>% dplyr::pull(var = 1)
    mat %>%
      t() %>%
      as.data.frame() %>%
      tibble::rownames_to_column(var = "file_id") %>%
      tibble::as_tibble() %>%
      dplyr::left_join(lookup_table) %>%
      dplyr::select(file_id, tcga_barcode, sample_type, everything()) %>%
      # select only primary tumors for now
      dplyr::filter(sample_type == "Primary Tumor") %>%
      dplyr::select(-file_id, -sample_type)
  })
  list("genus" = counts_barcodes[["genus"]], 
       "species" = counts_barcodes[["species"]],
       "taxid" = counts_barcodes[["taxid"]],
       "kingdom" = counts_barcodes[["kingdom"]],
       "clindat" = clindat)
}
# apply function to list
tcga_barcodes_list <- purrr::map(counts_clin_list, convert_to_barcodes)
tcga_barcodes_list

# IMMUNE CORRELATES--------------------------------------------
# read in
path_to_directory <- "~/sshfs_mount/TCGA/agamemnon_counts/"
imm_corr <- read_tsv(
  paste0(path_to_directory, "IMM_correlates.tsv")
  ) %>% 
  dplyr::select(tcga_barcode = `TCGA Participant Barcode`, everything())

# make immune correlates list
imm_corr_lister <- function(tcga_proj){
  imm_corr %>% dplyr::filter(`TCGA Study` == tcga_proj)
}
imm_corr_list <- purrr::map(tcga_proj, imm_corr_lister)

# LISTS BY TYPE--------------------------------------------
# functions to split lists by count types
genera_lister <- function(list_element){
  genera <- list_element[["genus"]]
genera
}
species_lister <- function(list_element){
  species <- list_element[["species"]]
  species
}
taxid_lister <- function(list_element){
  taxid <- list_element[["taxid"]]
  taxid
}
kingdom_lister <- function(list_element){
  kingdom <- list_element[["kingdom"]]
  kingdom
}
phylum_lister <- function(list_element){
  phylum <- list_element[["phylum"]]
  phylum
}
# apply functions to list
genera_list <- purrr::map(tcga_barcodes_list, genera_lister)
species_list <- purrr::map(tcga_barcodes_list, species_lister)
taxid_list <- purrr::map(tcga_barcodes_list, taxid_lister)
phylum_list <- purrr::map(tcga_barcodes_list, phylum_lister)
kingdom_list <- purrr::map(tcga_barcodes_list, kingdom_lister)

# create nested list of counts
counts_sublist <- list("kingdom" = kingdom_list,
                       "phylum" = phylum_list,
                       "genus" = genera_list,
                       "species" = species_list, 
                       "taxid" = taxid_list)

# add in clinical data and immune correlates
clindat_lister <- function(list_element){
  clindat <- list_element[["clindat"]]
  clindat
}
clindat_list <- purrr::map(tcga_barcodes_list, clindat_lister)

tcga_counts <- list("counts" = counts_sublist,
                    "clindat" = clindat_list,
                    "imm_cor" = imm_corr_list)

# SAVE FOR LATER USE---------------------------------------
saveRDS(tcga_counts, "data/tcga_counts_list.rds")

```

Check integrity 
```{r}
tcga_counts <- readRDS("data/tcga_counts_list.rds")
str(tcga_counts$counts, max.level = 2)
str(tcga_counts, max.level = 2)
tcga_counts$counts$genus$ACC
tcga_counts$counts$species$ACC
tcga_counts$counts$kingdom$ACC
```

Combine first and second batch
```{r}
batch_one <- readRDS("~/Projects/ag_microbiome/data/tcga_counts_list.rds")
batch_two <- readRDS("~/Projects/tcga_micro/data/tcga_counts_list.rds")

dropped <- which(names(batch_two$counts$genus) %in% c("STAD", "LAML"))
dropped
comb_genus <- c(batch_one$counts$genus, batch_two$counts$genus[-dropped])
str(comb_genus, max.level = 2)

comb_species <- c(batch_one$counts$species, batch_two$counts$species[-dropped])
str(comb_species, max.level = 2)

comb_taxid <- c(batch_one$counts$species, batch_two$counts$taxid[-dropped])
str(comb_taxid, max.level = 2)

comb_kingdom <- c(batch_one$counts$kingdom, batch_two$counts$kingdom[-dropped])
str(comb_kingdom, max.level = 2)

comb_phylum <- c(batch_one$counts$phylum, batch_two$counts$phylum[-dropped])
str(comb_phylum, max.level = 2)

comb_counts <- list("genus" = comb_genus,
                 "species" = comb_species,
                 "taxid" = comb_taxid,
                 "kingdom" = comb_kingdom,
                 "phylum" = comb_phylum)
str(comb_counts, max.level = 2)

comb_clindat <- c(batch_one$clindat, batch_two$clindat[-dropped])
str(comb_clindat, max.level = 2)

comb_imm_cor <- c(batch_one$imm_cor, batch_two$imm_cor[-dropped])
str(comb_imm_cor, max.level = 2)

comb_tcga_counts <- list("counts" = comb_counts, 
                         "clindat" = comb_clindat, 
                         "imm_cor" = comb_imm_cor)
str(comb_tcga_counts, max.level = 2)

saveRDS(comb_tcga_counts, "data/comb_tcga_counts_list.rds")
```
