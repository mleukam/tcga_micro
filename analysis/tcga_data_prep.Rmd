---
title: "tcga_data_prep"
author: "Michael Leukam"
date: "2021-02-02"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

## Setup

Clear the workspace and set seed
```{r}
rm(list=ls())
set.seed(818)
```

```{r}
knitr::opts_chunk$set(eval = FALSE)
```

Load packages
```{r}
# data cleaning
library(tidyverse)
library(Biobase)
library(Matrix.utils)
library(limma)
library(ggpubr)
library(edgeR)
```

Setup on local
```{bash, eval = FALSE}
sshfs mjl62@o2.hms.harvard.edu:/n/scratch3/users/m/mjl62 ~/sshfs_mount/TCGA

# get immune correlates
cd ~/sshfs_mount/TCGA/agamemnon_counts

curl https://contattafiles.s3.us-west-1.amazonaws.com/tnt40761/jOjcXzknipvEC1q/Characteristics.tsv > IMM_correlates.tsv
```

## Format counts
```{r}
# READ IN--------------------------------------------
setwd("~/sshfs_mount/TCGA/agamemnon_counts/mode2")

# make list of TCGA projects
tcga_proj <- list("BRCA" = "BRCA",
                  "LUAD" = "LUAD",
                  "GBM" = "GBM",
                  "LUSC" = "LUSC",
                  "SKCM" = "SKCM",
                  "STAD" = "STAD",
                  "LGG" = "LGG",
                  "UCEC" = "UCEC",
                  "KIRC" = "KIRC",
                  # "LAML" = "LAML", no samples in this folder
                  "HNSC" = "HNSC",
                  "THCA" = "THCA")
# second batch
# tcga_proj <- list("ACC" = "ACC",
#                  "BLCA" = "BLCA",
#                  "CESC" = "CESC",
#                  "COAD" = "COAD",
#                  "KICH" = "KICH",
#                  "KIRP" = "KIRP",
#                  "LAML" = "LAML",
#                  "LIHC" = "LIHC",
#                  "MESO" = "MESO",
#                  "PAAD" = "PAAD",
#                  "PCPG" = "PCPG",
#                  "PRAD" = "PRAD",
#                  "READ" = "READ",
#                  "SARC" = "SARC",
#                  "SKCM" = "SKCM",
#                  "STAD" = "STAD",
#                  "TGCT" = "TGCT",
#                  "THCA" = "THCA",
#                  "THYM" = "THYM",
#                  "UCS" = "UCS",
#                  "UVM" = "UVM")


# function to read in data for each project
file_loader <- function(tcga_proj){
  # assign path to data files
  path_to_directory <- "~/sshfs_mount/TCGA/agamemnon_counts/mode2/"
  # read in genus counts
  genus_counts <- read_csv(
  paste0(path_to_directory,
         tcga_proj, "_genus_counts.csv")
  )
   # read in species counts
  species_counts <- read_csv(
  paste0(path_to_directory, 
         tcga_proj, "_species_counts.csv")
  )
   # read in taxid counts
  taxid_counts <- read_csv(
    paste0(path_to_directory,
           tcga_proj, "_taxID_counts.csv")
  )
  # read in phylum counts
  phylum_counts <- read_csv(
    paste0(path_to_directory,
           tcga_proj, "_phylum_counts.csv")
  )
  # read in kingdom counts
  kingdom_counts <- read_csv(
    paste0(path_to_directory,
           tcga_proj, "_kingdom_counts.csv")
  )
  # read in clinical data
  clindat <- read_csv(
    paste0(path_to_directory, 
           tcga_proj, "_clindata.csv")
  ) %>%
    # keep only primary tumor data
    dplyr::filter(sample_type == "Primary Tumor") %>%
    # convert explicit attributes table to standard tbl
    # honestly because it is annoying for str() calls
    # and does not look pretty
    select(everything())
  # make counts tables into a list for batch processing
  counts <- list(genus_counts, 
                 species_counts, 
                 taxid_counts, 
                 kingdom_counts, 
                 phylum_counts)
  names(counts) <- c("genus", "species", "taxid", "kingdom", "phylum")
  # return a list of counts (nested) and clinical data
  combined_list <- list("counts" = counts, "clindat" = clindat)
  combined_list
}
# apply function to list
counts_clin_list <- purrr::map(tcga_proj, file_loader)
str(counts_clin_list, max.level = 2)

# FIX ROWNAMES--------------------------------------------
# function to convert file_ids to legacy TCGA barcodes
# using conversion columns in clindata
convert_to_barcodes <- function(list_as_element){
  clindat <- list_as_element[["clindat"]]
  imm_cor <- list_as_element[["imm_cor"]]
  
  lookup_table <- clindat %>% dplyr::select(file_id, 
                                            tcga_barcode, 
                                            sample_type)
  counts_tables <- list_as_element[["counts"]]
  counts_barcodes <- map(counts_tables, function(df){
    mat <- df[-1] %>%
      as.matrix()
    rownames(mat) <- df %>% dplyr::pull(var = 1)
    mat %>%
      t() %>%
      as.data.frame() %>%
      tibble::rownames_to_column(var = "file_id") %>%
      tibble::as_tibble() %>%
      dplyr::left_join(lookup_table) %>%
      dplyr::select(file_id, tcga_barcode, sample_type, everything()) %>%
      # select only primary tumors for now
      dplyr::filter(sample_type == "Primary Tumor") %>%
      dplyr::select(-file_id, -sample_type)
  })
  list("genus" = counts_barcodes[["genus"]], 
       "species" = counts_barcodes[["species"]],
       "taxid" = counts_barcodes[["taxid"]],
       "kingdom" = counts_barcodes[["kingdom"]],
       "phylum" = counts_barcodes[["phylum"]],
       "clindat" = clindat)
}
# apply function to list
tcga_barcodes_list <- purrr::map(counts_clin_list, convert_to_barcodes)
str(tcga_barcodes_list, max.level = 2)

# IMMUNE CORRELATES--------------------------------------------
# read in locally saved copy
imm_corr <- read_tsv("~/Projects/tcga_micro/data/imm_cor_souce.tsv") %>%
  dplyr::select(tcga_barcode = `TCGA Participant Barcode`, everything())

# make immune correlates list
imm_corr_lister <- function(tcga_proj){
  imm_corr %>% dplyr::filter(`TCGA Study` == tcga_proj)
}
imm_corr_list <- purrr::map(tcga_proj, imm_corr_lister)

# LISTS BY TYPE--------------------------------------------
# functions to split lists by count types
genera_lister <- function(list_element){
  genera <- list_element[["genus"]]
genera
}
species_lister <- function(list_element){
  species <- list_element[["species"]]
  species
}
taxid_lister <- function(list_element){
  taxid <- list_element[["taxid"]]
  taxid
}
kingdom_lister <- function(list_element){
  kingdom <- list_element[["kingdom"]]
  kingdom
}
phylum_lister <- function(list_element){
  phylum <- list_element[["phylum"]]
  phylum
}
# apply functions to list
genera_list <- purrr::map(tcga_barcodes_list, genera_lister)
species_list <- purrr::map(tcga_barcodes_list, species_lister)
taxid_list <- purrr::map(tcga_barcodes_list, taxid_lister)
phylum_list <- purrr::map(tcga_barcodes_list, phylum_lister)
kingdom_list <- purrr::map(tcga_barcodes_list, kingdom_lister)

# create nested list of counts
counts_sublist <- list("kingdom" = kingdom_list,
                       "phylum" = phylum_list,
                       "genus" = genera_list,
                       "species" = species_list, 
                       "taxid" = taxid_list)

# add in clinical data and immune correlates
clindat_lister <- function(list_element){
  clindat <- list_element[["clindat"]]
  clindat
}
clindat_list <- purrr::map(tcga_barcodes_list, clindat_lister)

tcga_counts <- list("counts" = counts_sublist,
                    "clindat" = clindat_list,
                    "imm_cor" = imm_corr_list)

# SAVE FOR LATER USE---------------------------------------
saveRDS(tcga_counts, "~/Projects/tcga_micro/data/tcga_counts_list_mode2.rds")

```

Check integrity 
```{r}
tcga_counts <- readRDS("~/Projects/tcga_micro/data/tcga_counts_list_mode2.rds")
str(tcga_counts$counts, max.level = 2)
str(tcga_counts, max.level = 2)
tcga_counts$counts$genus$STAD
# problem - Tissierella_Class is still called ---_Class
tcga_counts$counts$genus <- tcga_counts$counts$genus %>% 
  map(~ dplyr::rename(., Tissierella_Class = `---_Class`))
tcga_counts$counts$genus$STAD
tcga_counts$counts$species$STAD
tcga_counts$counts$kingdom$STAD
tcga_counts$counts$taxid$STAD

```

## Data Cleaning

#### Convert to CPM
https://rna-seqblog.com/rpkm-fpkm-and-tpm-clearly-explained/#:~:text=Count%20up%20the%20total%20reads,of%20the%20gene%2C%20in%20kilobases.
```{r}
setwd("~/Projects/tcga_micro")
# read in readcounts from /code/get_reads_v2.sh
# moved over from HPC to data folder using filezilla
totreads_tbl <- read_csv("data/2021_01_20_readcounts.csv", col_names = FALSE) %>%
  dplyr::rename(tcga_proj = X1,
                file_id = X2,
                totreads = X3) %>%
  # STAD results were stored in folder named "STAD_mode2"
  # need to fix project names
  # remove leftover old STAD values
  dplyr::filter(!tcga_proj == "TCGA_STAD") %>%
  # remove `TCGA_` prefix from projects and _mode2 suffix
  separate(tcga_proj, into = c(NA, "tcga_proj", NA), sep = "_", ) %>%
  print()
  
summary(as.factor(totreads_tbl$tcga_proj))

# add total reads to clinical data using file_id
clindat_tbl_list <- tcga_counts$clindat %>%
  enframe %>%
  unnest(value) %>%
  left_join(totreads_tbl, by = "file_id") %>%
  dplyr::select(name, tcga_barcode, totreads, everything()) %>%
  group_by(name) %>%
  nest() %>%
  deframe()
str(clindat_tbl_list, max.level = 1)
clindat_tbl_list[1]

# make simplified lookup table
reads_lookup <- clindat_tbl_list %>%
  enframe() %>%
  unnest(value) %>%
  dplyr::select(tcga_barcode, totreads) %>%
  print()

# genus CPM conversion
genusflat <- tcga_counts$counts$genus %>%
  enframe() %>%
  unnest(value) %>%
  left_join(reads_lookup) %>%
  dplyr::select(name, tcga_barcode, totreads, everything()) %>%
  # take out those lacking total reads data
  dplyr::filter(!is.na(totreads)) %>%
  print()
genus_cpm <- genusflat %>%
  # get per million scaling factor
  mutate(factor = totreads / 10^6) %>%
  select(-totreads) %>%
  # divide by readcounts
  mutate(across(-c(factor, name, tcga_barcode), ~ . / factor)) %>%
  dplyr::select(-factor) %>%
  group_by(name) %>%
  nest() %>%
  deframe()

# species
speciesflat <- tcga_counts$counts$species %>%
  enframe() %>%
  unnest(value) %>%
  left_join(reads_lookup) %>%
  dplyr::select(name, tcga_barcode, totreads, everything()) %>%
  # take out those lacking total reads data
  dplyr::filter(!is.na(totreads)) %>%
  print()
species_cpm <- speciesflat %>%
  # get per million scaling factor
  mutate(factor = totreads / 10^6) %>%
  select(-totreads) %>%
  # divide by readcounts
  mutate(across(-c(factor, name, tcga_barcode), ~ . / factor)) %>%
  dplyr::select(-factor) %>%
  group_by(name) %>%
  nest() %>%
  deframe()

# phylum
phylumflat <- tcga_counts$counts$phylum %>%
  enframe() %>%
  unnest(value) %>%
  left_join(reads_lookup) %>%
  dplyr::select(name, tcga_barcode, totreads, everything()) %>%
  # take out those lacking total reads data
  dplyr::filter(!is.na(totreads)) %>%
  print()
phylum_cpm <- phylumflat %>%
  # get per million scaling factor
  mutate(factor = totreads / 10^6) %>%
  select(-totreads) %>%
  # divide by readcounts
  mutate(across(-c(factor, name, tcga_barcode), ~ . / factor)) %>%
  dplyr::select(-factor) %>%
  group_by(name) %>%
  nest() %>%
  deframe()

# taxid
taxidflat <- tcga_counts$counts$taxid %>%
  enframe() %>%
  unnest(value) %>%
  left_join(reads_lookup) %>%
  dplyr::select(name, tcga_barcode, totreads, everything()) %>%
  # take out those lacking total reads data
  dplyr::filter(!is.na(totreads)) %>%
  print()
taxid_cpm <- taxidflat %>%
  # get per million scaling factor
  mutate(factor = totreads / 10^6) %>%
  select(-totreads) %>%
  # divide by scaling factor
  mutate(across(-c(factor, name, tcga_barcode), ~ . / factor)) %>%
  dplyr::select(-factor) %>%
  group_by(name) %>%
  nest() %>%
  deframe()
taxid_cpm

kingdomflat <- tcga_counts$counts$kingdom %>%
  enframe() %>%
  unnest(value) %>%
  left_join(reads_lookup) %>%
  dplyr::select(name, tcga_barcode, totreads, everything()) %>%
  # dplyr::select(-`NA`) %>%
  # take out those lacking total reads data
  dplyr::filter(!is.na(totreads)) %>%
  print()
kingdom_cpm <- kingdomflat %>%
  # get per million scaling factor
  mutate(factor = totreads / 10^6) %>%
  select(-totreads) %>%
  # divide by scaling factor
  mutate(across(-c(factor, name, tcga_barcode), ~ . / factor)) %>%
  dplyr::select(-factor) %>%
  group_by(name) %>%
  nest() %>%
  deframe()
kingdom_cpm

cpm_counts <- list("kingdom_cpm" = kingdom_cpm, 
                   "phylum_cpm" = phylum_cpm, 
                   "genus_cpm" = genus_cpm, 
                   "species_cpm" = species_cpm, 
                   "taxid_cpm" = taxid_cpm,
                   "cpm_clindat" = clindat_tbl_list)

tcga_counts[["cpm_counts"]] <- cpm_counts

str(tcga_counts, max.level = 2)

saveRDS(tcga_counts, "data/mode2_tcga_counts_list_clean.rds")
```


